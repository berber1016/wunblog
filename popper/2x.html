<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前言 | wun blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="berber/胜利 博客">
    <meta name="keywords" content="博客 berber1016的博客 个人博客">
    
    <link rel="preload" href="/assets/css/0.styles.a1050808.css" as="style"><link rel="preload" href="/assets/js/app.bd205e11.js" as="script"><link rel="preload" href="/assets/js/3.eb454419.js" as="script"><link rel="preload" href="/assets/js/1.88cb3713.js" as="script"><link rel="preload" href="/assets/js/13.f9620b26.js" as="script"><link rel="prefetch" href="/assets/js/10.3cba73d9.js"><link rel="prefetch" href="/assets/js/11.7bcc9995.js"><link rel="prefetch" href="/assets/js/12.d5e2cbf8.js"><link rel="prefetch" href="/assets/js/14.8bb9cae3.js"><link rel="prefetch" href="/assets/js/15.c87439fe.js"><link rel="prefetch" href="/assets/js/16.2d1bbd9a.js"><link rel="prefetch" href="/assets/js/17.b011aab8.js"><link rel="prefetch" href="/assets/js/18.8ca79c53.js"><link rel="prefetch" href="/assets/js/19.71f9f76d.js"><link rel="prefetch" href="/assets/js/20.79b68d49.js"><link rel="prefetch" href="/assets/js/21.cf8ce4ca.js"><link rel="prefetch" href="/assets/js/4.ba359ddf.js"><link rel="prefetch" href="/assets/js/5.b20330d0.js"><link rel="prefetch" href="/assets/js/6.d5e60b9f.js"><link rel="prefetch" href="/assets/js/7.545067f8.js"><link rel="prefetch" href="/assets/js/8.2001d7e5.js"><link rel="prefetch" href="/assets/js/9.3c349e38.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a1050808.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-06036f94><div data-v-06036f94><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-06036f94 data-v-06036f94><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4a1cf9c0 data-v-06036f94 data-v-06036f94><h3 class="title" data-v-4a1cf9c0 data-v-4a1cf9c0>wun blog</h3> <p class="description" data-v-4a1cf9c0 data-v-4a1cf9c0>berber/胜利 博客</p> <label id="box" class="inputBox" data-v-4a1cf9c0 data-v-4a1cf9c0><input type="password" value="" data-v-4a1cf9c0> <span data-v-4a1cf9c0>Konck! Knock!</span> <button data-v-4a1cf9c0>OK</button></label> <div class="footer" data-v-4a1cf9c0 data-v-4a1cf9c0><span data-v-4a1cf9c0><i class="iconfont reco-theme" data-v-4a1cf9c0></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4a1cf9c0>vuePress-theme-reco</a></span> <span data-v-4a1cf9c0><i class="iconfont reco-copyright" data-v-4a1cf9c0></i> <a data-v-4a1cf9c0><!---->
            
          <!---->
          2022
        </a></span></div></div> <div class="hide" data-v-06036f94><header class="navbar" data-v-06036f94><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">wun blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><a href="https://github.com/berber1016" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://juejin.cn/user/1714893868770846" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://berber1016.github.io/typescript-eslint-chinese/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  typescript-eslint 翻译
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-06036f94></div> <aside class="sidebar" data-v-06036f94><div class="personal-info-wrapper" data-v-9487530a data-v-06036f94><!----> <!----> <div class="num" data-v-9487530a><div data-v-9487530a><h3 data-v-9487530a>9</h3> <h6 data-v-9487530a>文章</h6></div> <div data-v-9487530a><h3 data-v-9487530a>0</h3> <h6 data-v-9487530a>标签</h6></div></div> <ul class="social-links" data-v-9487530a></ul> <hr data-v-9487530a></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><a href="https://github.com/berber1016" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://juejin.cn/user/1714893868770846" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://berber1016.github.io/typescript-eslint-chinese/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  typescript-eslint 翻译
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/rc-component/index" class="sidebar-heading clickable"><span>rc-component</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/popper/index" class="sidebar-heading clickable open"><span>popper源码</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/popper/2x.html" aria-current="page" class="active sidebar-link">2.x</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/translation/index" class="sidebar-heading clickable"><span>一些译文</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4a1cf9c0 data-v-06036f94><h3 class="title" data-v-4a1cf9c0 data-v-4a1cf9c0></h3> <!----> <label id="box" class="inputBox" data-v-4a1cf9c0 data-v-4a1cf9c0><input type="password" value="" data-v-4a1cf9c0> <span data-v-4a1cf9c0>Konck! Knock!</span> <button data-v-4a1cf9c0>OK</button></label> <div class="footer" data-v-4a1cf9c0 data-v-4a1cf9c0><span data-v-4a1cf9c0><i class="iconfont reco-theme" data-v-4a1cf9c0></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4a1cf9c0>vuePress-theme-reco</a></span> <span data-v-4a1cf9c0><i class="iconfont reco-copyright" data-v-4a1cf9c0></i> <a data-v-4a1cf9c0><!---->
            
          <!---->
          2022
        </a></span></div></div> <div data-v-06036f94><main class="page"><section><div class="page-title"><h1 class="title">前言</h1> <div data-v-14d37458><!----> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>作为前端，<code>popper.js</code>是绕不过去的一道坎，它作为底层组件，帮助我们解决了 <code>Tooltip</code>、<code>dropdown</code>、<code>Menu</code>等等一系列组件。几乎所有的这样的组件都是基于<code>Popper.js</code>组件来构成的。它的核心只有6000 byte左右，并且支持<code>tree-shaking</code>，支持自定义中间件、支持任意框架(基于 <code>JavaScript</code>)。</p> <blockquote><p>当前是基于v2.x分支作为分析，仅针对2.x分支分析。最新版本的popper.js已经更名为floating-ui。</p></blockquote> <h2 id="基本逻辑"><a href="#基本逻辑" class="header-anchor">#</a> 基本逻辑</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> defaultModifiers <span class="token operator">=</span> <span class="token punctuation">[</span>
  eventListeners<span class="token punctuation">,</span>
  popperOffsets<span class="token punctuation">,</span>
  computeStyles<span class="token punctuation">,</span>
  applyStyles<span class="token punctuation">,</span>
  offset<span class="token punctuation">,</span>
  flip<span class="token punctuation">,</span>
  preventOverflow<span class="token punctuation">,</span>
  arrow<span class="token punctuation">,</span>
  hide<span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> createPopper <span class="token operator">=</span> <span class="token function">popperGenerator</span><span class="token punctuation">(</span><span class="token punctuation">{</span> defaultModifiers <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>popper.js 利用 <code>popperGenerator</code>来生成 <code>createPopper</code> 函数，其中初始化了一些中间件。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">DEFAULT_OPTIONS</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">placement</span><span class="token operator">:</span> <span class="token string">'bottom'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">modifiers</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">strategy</span><span class="token operator">:</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">popperGenerator</span><span class="token punctuation">(</span><span class="token parameter">generatorOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
        defaultModifiers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        defaultOptions <span class="token operator">=</span> <span class="token constant">DEFAULT_OPTIONS</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> generatorOptions<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">createPopper</span><span class="token punctuation">(</span><span class="token parameter">referance<span class="token punctuation">,</span>popper<span class="token punctuation">,</span>options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...some code</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> effectCleanupFns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> isDestroyed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token punctuation">{</span>
            state<span class="token punctuation">,</span>
            <span class="token function">setOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">// ...some code</span>
                <span class="token function">cleanupModifierEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// ...some code</span>
                <span class="token function">runModifierEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> instance<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">// ...some code</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    instance<span class="token punctuation">.</span><span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>            
            <span class="token function">destory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">// ...some code</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        instance<span class="token punctuation">.</span><span class="token function">setOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDestroyed <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>onFirstUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                options<span class="token punctuation">.</span><span class="token function">onFirstUpdate</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">function</span> <span class="token function">runModifierEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// ...some code </span>
        <span class="token punctuation">}</span>
        <span class="token keyword">function</span> <span class="token function">cleanupModifierEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// ...some code </span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>利用<code>popperGenerator</code>初始化了一些 <code>modifiers</code>、<code>options</code>，生成<code>createPopper</code>函数必备的一些参数，当执行<code>createPopper</code>时，<code>setOptions</code> -&gt; <code>cleanupModifierEffects()</code> -&gt; <code>runModifierEffects()</code> -&gt; <code>update</code> -&gt; <code>forceUpdate()</code>。不仅仅可以利用<code>createPopper</code>来直接使用，我们还可以利用<code>popperGenerator</code>来自定义 <code>popper</code> 更新策略。整体代码执行顺序及设计十分巧妙，利用<code>effect</code>处理副作用，然后顺序执行 <code>Modifier[fn]</code>来计算、生成、检测是否溢出等。</p> <h3 id="初始化"><a href="#初始化" class="header-anchor">#</a> 初始化</h3> <h4 id="setoptions"><a href="#setoptions" class="header-anchor">#</a> setOptions</h4> <p>初始化时执行一次 <code>setOptions</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// ...some code </span>
  <span class="token function">cleanupModifierEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...some code</span>
  <span class="token function">runModifierEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> instance<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p><code>runModifierEffects</code> 和 <code>cleanupModifierEffects</code> 其功能类似于<code>react</code>的 <code>useEffect</code>，Effect 副作用函数，会直接或者间接的影响其他函数的执行。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// react useEffect</span>
<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">// some code such as: addEventListener</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token comment">//some code such as: removeEventListener</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// popper.js</span>
<span class="token function">runModifierEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token comment">//   每一个modifier执行 runModifierEffect</span>
    state<span class="token punctuation">.</span>orderedModifiers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">modifier</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">runModifierEffect</span><span class="token punctuation">(</span>modifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">runModifierEffect</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> effect <span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> effect <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 执行 effect</span>
                <span class="token keyword">const</span> cleanupFn <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">{</span> state<span class="token punctuation">,</span> name<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> options <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> <span class="token function-variable function">noopFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token comment">// push effect的返回结果</span>
                effectCleanupFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cleanupFn <span class="token operator">||</span> noopFn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">cleanupModifierEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    effectCleanupFns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    effectCleanupFns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>有没有很像，有没有~ 还没看出来吗，没关系，我们利用代入法，用一个eventListenersModifier来表达一下这里的关系</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> state<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> options <span class="token punctuation">}</span><span class="token operator">:</span> ModifierArguments<span class="token operator">&lt;</span>Options<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> scroll <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> resize <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
  <span class="token keyword">const</span> window <span class="token operator">=</span> <span class="token function">getWindow</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>elements<span class="token punctuation">.</span>popper<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> scrollParents <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token operator">...</span>state<span class="token punctuation">.</span>scrollParents<span class="token punctuation">.</span>reference<span class="token punctuation">,</span>
    <span class="token operator">...</span>state<span class="token punctuation">.</span>scrollParents<span class="token punctuation">.</span>popper<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>scroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    scrollParents<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">scrollParent</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      scrollParent<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span>update<span class="token punctuation">,</span> passive<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>resize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'resize'</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span>update<span class="token punctuation">,</span> passive<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>scroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      scrollParents<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">scrollParent</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        scrollParent<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span>update<span class="token punctuation">,</span> passive<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'resize'</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span>update<span class="token punctuation">,</span> passive<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'eventListeners'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">enabled</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">phase</span><span class="token operator">:</span> <span class="token string">'write'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  effect<span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token operator">:</span> EventListenersModifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>当执行 <code>runMidifierEffects</code>时，会对 <code>scrollParent</code>添加<code>addEventListener</code>、对<code>window</code>添加<code>addEventListener</code>，当执行<code>clearnUpModifierEffects</code>时，会执行<code>removeEventLIstener</code>来移除事件监听。</p> <p>最后，<code>setOptions</code>返回 <code>instance.update()</code>的执行结果</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token literal-property property">update</span><span class="token operator">:</span> <span class="token function">debounce</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span> <span class="token operator">&lt;</span> $Shape <span class="token operator">&lt;</span> State <span class="token operator">&gt;&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    instance<span class="token punctuation">.</span><span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre></div><p>这里加了一个防抖，防止多次触发 <code>forceUpdate()</code>，比如说在上面看到的<code>EventListenersModifier</code>，当触发<code>scroll</code>、<code>resize</code>时，可能会频繁触发 <code>update</code>函数，导致多次执行，所以这里加了防抖。</p> <h4 id="forceupdate"><a href="#forceupdate" class="header-anchor">#</a> <code>forceUpdate</code></h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// destroyed标志</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> reference<span class="token punctuation">,</span> popper <span class="token punctuation">}</span> <span class="token operator">=</span> state<span class="token punctuation">.</span>elements<span class="token punctuation">;</span>
    <span class="token comment">//校验 reference、popper元素是否可用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">areValidElements</span><span class="token punctuation">(</span>reference<span class="token punctuation">,</span> popper<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 存储reference和popper rect以供 modifiers读取</span>
    state<span class="token punctuation">.</span>rects <span class="token operator">=</span> <span class="token punctuation">{</span>
     <span class="token literal-property property">reference</span><span class="token operator">:</span> <span class="token function">getCompositeRect</span><span class="token punctuation">(</span>
                   reference<span class="token punctuation">,</span>
                   <span class="token function">getOffsetParent</span><span class="token punctuation">(</span>popper<span class="token punctuation">)</span><span class="token punctuation">,</span>
                   state<span class="token punctuation">.</span>options<span class="token punctuation">.</span>strategy <span class="token operator">===</span> <span class="token string">'fixed'</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token literal-property property">popper</span><span class="token operator">:</span> <span class="token function">getLayoutRect</span><span class="token punctuation">(</span>popper<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    state<span class="token punctuation">.</span>reset <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    state<span class="token punctuation">.</span>placement <span class="token operator">=</span> state<span class="token punctuation">.</span>options<span class="token punctuation">.</span>placements<span class="token punctuation">;</span>
    <span class="token comment">// 遍历orderedModifiers 每次更新重新填充 modifiersData</span>
    state<span class="token punctuation">.</span>orderedModifiers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">modifier</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
                    <span class="token punctuation">(</span>state<span class="token punctuation">.</span>modifiersData<span class="token punctuation">[</span>modifier<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
                        <span class="token operator">...</span>modifier<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 遍历orderedModifiers 取出 modifier[fn] 执行</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> state<span class="token punctuation">.</span>orderedModifiers<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>reset <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                state<span class="token punctuation">.</span>reset <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> fn<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> state<span class="token punctuation">.</span>orderedModifiers<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             state <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">{</span> state<span class="token punctuation">,</span> options<span class="token punctuation">,</span> name<span class="token punctuation">,</span> instance <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">||</span> state<span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="rects"><a href="#rects" class="header-anchor">#</a> Rects</h5> <ol><li><h5 id="popper"><a href="#popper" class="header-anchor">#</a> <code>popper</code></h5></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 存储reference和popper rect以供 modifiers读取</span>
state<span class="token punctuation">.</span>rects <span class="token operator">=</span> <span class="token punctuation">{</span>
   <span class="token comment">// some code </span>
   <span class="token literal-property property">popper</span><span class="token operator">:</span> <span class="token function">getLayoutRect</span><span class="token punctuation">(</span>popper<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">getLayoutRect</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">element</span><span class="token operator">:</span> HTMLElement</span><span class="token punctuation">)</span><span class="token operator">:</span> Rect <span class="token punctuation">{</span>
  <span class="token keyword">const</span> clientRect <span class="token operator">=</span> <span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Use the clientRect sizes if it's not been transformed.</span>
  <span class="token comment">// Fixes https://github.com/popperjs/popper-core/issues/1223</span>
  <span class="token keyword">let</span> width <span class="token operator">=</span> element<span class="token punctuation">.</span>offsetWidth<span class="token punctuation">;</span>
  <span class="token keyword">let</span> height <span class="token operator">=</span> element<span class="token punctuation">.</span>offsetHeight<span class="token punctuation">;</span>
  <span class="token comment">// 由于getBoundingClientRect是基于 getClientRects的，mdn中说明到，小数级别的像素偏移是有可能的。这里做了一些容错。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>clientRect<span class="token punctuation">.</span>width <span class="token operator">-</span> width<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    width <span class="token operator">=</span> clientRect<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>clientRect<span class="token punctuation">.</span>height <span class="token operator">-</span> height<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    height <span class="token operator">=</span> clientRect<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token comment">// 返回element距离element.offsetParent的左边界偏移的像素值</span>
    <span class="token literal-property property">x</span><span class="token operator">:</span> element<span class="token punctuation">.</span>offsetLeft<span class="token punctuation">,</span>
    <span class="token comment">// 同上</span>
    <span class="token literal-property property">y</span><span class="token operator">:</span> element<span class="token punctuation">.</span>offsetTop<span class="token punctuation">,</span>
    width<span class="token punctuation">,</span>
    height<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><ol><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Element/getBoundingClientRect" target="_blank" rel="noopener noreferrer">getBoundingClientRect<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>方法返回元素大小及其相对<strong>视窗(viewport)</strong> 的位置。</li></ol> <blockquote><p>如果是标准盒子模型，元素的尺寸等于<code>width/height</code> + <code>padding</code> + <code>border-width</code>的总和。如果<code>box-sizing: border-box</code>，元素的的尺寸等于 <code>width/height</code>。</p></blockquote> <blockquote><p>返回的结果是包含完整元素的最小矩形，并且拥有<code>left</code>, <code>top</code>, <code>right</code>, <code>bottom</code>, <code>x</code>, <code>y</code>, <code>width</code>, 和 <code>height</code>这几个以像素为单位的只读属性用于描述整个边框。除了<code>width</code> 和 <code>height</code> 以外的属性是相对于视图窗口的左上角来计算的。</p></blockquote> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3b304c760fc347719ca76ceae13944b7~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p> <ol start="2"><li><code>offsetWidth / offsetHeight</code> = <code>width/height</code> + <code>padding</code> + <code>border-width</code> <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/42e69676718f4083aa9717cdb428fba0~tplv-k3u1fbpfcp-zoom-1.image" alt=""></li></ol> <p>由于<code>getBoundingClientRect</code>是基于 getClientRects的，mdn中说明到，小数级别的像素偏移是有可能的，所以在代码中做了一些容错做了一些容错。关于ClientRect是什么可以看这里 <a href="https://developer.mozilla.org/en-US/docs/Web/API/DOMRect" target="_blank" rel="noopener noreferrer">DomRect<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <ol start="3"><li><code>offsetLeft/offsetTop</code></li></ol> <p>返回当前元素左上角相对于<code>offsetParent</code>左边/上边偏移的像素值</p> <p><code>offsetParent</code>元素只可能是下面这几种情况：</p> <ul><li><code>&lt;body&gt;</code></li></ul> <ul><li><code>position</code>不是<code>static</code>的元素(position 默认值是 <code>static</code>)</li></ul> <ul><li><code>&lt;table&gt;</code>, <code>&lt;th&gt;</code> 或<code>&lt;td&gt;</code>，但必须要<code>position: static</code>。</li></ul> <p>实际这个 <code>getLayoutRect</code>返回了 <code>popper</code> 的 <code>width/height</code>和 距离 <code>reference</code> 的x,y(一般情况下都是采用position:absolute | fixed)</p> <blockquote><p>有关更多各种offsetXXX的属性可以看张鑫旭大佬的这篇文章 <a href="https://www.zhangxinxu.com/wordpress/2011/09/cssom%e8%a7%86%e5%9b%be%e6%a8%a1%e5%bc%8fcssom-view-module%e7%9b%b8%e5%85%b3%e6%95%b4%e7%90%86%e4%b8%8e%e4%bb%8b%e7%bb%8d/" target="_blank" rel="noopener noreferrer">CSSOM视图模式(CSSOM View Module)相关整理 « 张鑫旭-鑫空间-鑫生活<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 里面还贴心的配备了各种demo。给大佬点赞！！！。</p></blockquote> <ol start="2"><li><h5 id="reference"><a href="#reference" class="header-anchor">#</a> <code>reference</code></h5></li></ol> <div class="language-js extra-class"><pre class="language-js"><code>state<span class="token punctuation">.</span>rects <span class="token operator">=</span> <span class="token punctuation">{</span>
   <span class="token literal-property property">reference</span><span class="token operator">:</span> <span class="token function">getCompositeRect</span><span class="token punctuation">(</span>
        reference<span class="token punctuation">,</span>
        <span class="token function">getOffsetParent</span><span class="token punctuation">(</span>popper<span class="token punctuation">)</span><span class="token punctuation">,</span>
        state<span class="token punctuation">.</span>options<span class="token punctuation">.</span>strategy <span class="token operator">===</span> <span class="token string">'fixed'</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token comment">// some code</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 获取一个正确的offsetParent 针对 Element.offsetParent的特殊情况纠正</span>
<span class="token keyword">function</span> <span class="token function">getOffsetParent</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">element</span><span class="token operator">:</span> Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> window <span class="token operator">=</span> <span class="token function">getWindow</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> offsetParent <span class="token operator">=</span> <span class="token function">getTrueOffsetParent</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>
    offsetParent <span class="token operator">&amp;&amp;</span>
    <span class="token function">isTableElement</span><span class="token punctuation">(</span>offsetParent<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token function">getComputedStyle</span><span class="token punctuation">(</span>offsetParent<span class="token punctuation">)</span><span class="token punctuation">.</span>position <span class="token operator">===</span> <span class="token string">'static'</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    offsetParent <span class="token operator">=</span> <span class="token function">getTrueOffsetParent</span><span class="token punctuation">(</span>offsetParent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    offsetParent <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span><span class="token function">getNodeName</span><span class="token punctuation">(</span>offsetParent<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'html'</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span><span class="token function">getNodeName</span><span class="token punctuation">(</span>offsetParent<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'body'</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">getComputedStyle</span><span class="token punctuation">(</span>offsetParent<span class="token punctuation">)</span><span class="token punctuation">.</span>position <span class="token operator">===</span> <span class="token string">'static'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> window<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> offsetParent <span class="token operator">||</span> <span class="token function">getContainingBlock</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token operator">||</span> window<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">getTrueOffsetParent</span><span class="token punctuation">(</span>element<span class="token operator">:</span> Element<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">?</span>Element <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token operator">!</span><span class="token function">isHTMLElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token comment">// https://github.com/popperjs/popper-core/issues/837</span>
    <span class="token function">getComputedStyle</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">.</span>position <span class="token operator">===</span> <span class="token string">'fixed'</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> element<span class="token punctuation">.</span>offsetParent<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p><code>getOffsetParent</code> 函数返回值为 <code>offsetParent</code> | <code>window</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getCompositeRect</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">elementOrVirtualElement</span><span class="token operator">:</span> Element <span class="token operator">|</span> VirtualElement<span class="token punctuation">,</span>
  <span class="token literal-property property">offsetParent</span><span class="token operator">:</span> Element <span class="token operator">|</span> Window<span class="token punctuation">,</span>
  <span class="token literal-property property">isFixed</span><span class="token operator">:</span> boolean <span class="token operator">=</span> <span class="token boolean">false</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> Rect <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOffsetParentAnElement <span class="token operator">=</span> <span class="token function">isHTMLElement</span><span class="token punctuation">(</span>offsetParent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> offsetParentIsScaled <span class="token operator">=</span>
    <span class="token function">isHTMLElement</span><span class="token punctuation">(</span>offsetParent<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isElementScaled</span><span class="token punctuation">(</span>offsetParent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> documentElement <span class="token operator">=</span> <span class="token function">getDocumentElement</span><span class="token punctuation">(</span>offsetParent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 取到 DomRect</span>
  <span class="token keyword">const</span> rect <span class="token operator">=</span> <span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span>
    elementOrVirtualElement<span class="token punctuation">,</span>
    offsetParentIsScaled
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ------------------开始计算scroll和offsets</span>
  <span class="token keyword">let</span> scroll <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">scrollLeft</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">scrollTop</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> offsets <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isOffsetParentAnElement <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>isOffsetParentAnElement <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isFixed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token function">getNodeName</span><span class="token punctuation">(</span>offsetParent<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'body'</span> <span class="token operator">||</span>
      <span class="token comment">// https://github.com/popperjs/popper-core/issues/1078</span>
      <span class="token function">isScrollParent</span><span class="token punctuation">(</span>documentElement<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      scroll <span class="token operator">=</span> <span class="token function">getNodeScroll</span><span class="token punctuation">(</span>offsetParent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isHTMLElement</span><span class="token punctuation">(</span>offsetParent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      offsets <span class="token operator">=</span> <span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span>offsetParent<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      offsets<span class="token punctuation">.</span>x <span class="token operator">+=</span> offsetParent<span class="token punctuation">.</span>clientLeft<span class="token punctuation">;</span>
      offsets<span class="token punctuation">.</span>y <span class="token operator">+=</span> offsetParent<span class="token punctuation">.</span>clientTop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>documentElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      offsets<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">getWindowScrollBarX</span><span class="token punctuation">(</span>documentElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ------------------计算结束-------------------</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
   <span class="token comment">// left + scrollLeft - offsetParent.clientLeft</span>
    <span class="token literal-property property">x</span><span class="token operator">:</span> rect<span class="token punctuation">.</span>left <span class="token operator">+</span> scroll<span class="token punctuation">.</span>scrollLeft <span class="token operator">-</span> offsets<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
    <span class="token comment">// top + scrollTop - offsetParent.clientTop</span>
    <span class="token literal-property property">y</span><span class="token operator">:</span> rect<span class="token punctuation">.</span>top <span class="token operator">+</span> scroll<span class="token punctuation">.</span>scrollTop <span class="token operator">-</span> offsets<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
    <span class="token literal-property property">width</span><span class="token operator">:</span> rect<span class="token punctuation">.</span>width<span class="token punctuation">,</span>
    <span class="token literal-property property">height</span><span class="token operator">:</span> rect<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>emmmm,这里的x,y我也没看太懂为啥要减去 <code>offset.x|y</code>，暂时就当他为0吧。。。。看了半天实际上就是返回了<code>reference</code>的<code>width，height</code>以及<code>left+scrollLeft</code>和<code>top+scrollTop</code></p> <hr> <p>可以看出来的是，每次update时，会重新计算rects、modifiersData，重新执行modifier[fn]。</p> <p>通过上面的代码，可以看出 不同的Modifier主要是影响了两个部分</p> <ol><li>effect的执行，仅在setOptions时执行，只在generator时 执行了一次</li> <li>modifier[fn]的执行，仅在Update时执行。update的执行可由effect来控制。每次触发eventListener都会执行。</li></ol> <h3 id="modifiers"><a href="#modifiers" class="header-anchor">#</a> Modifiers</h3> <h4 id="effect"><a href="#effect" class="header-anchor">#</a> Effect</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> defaultModifiers <span class="token operator">=</span> <span class="token punctuation">[</span>
  eventListeners<span class="token punctuation">,</span>
  popperOffsets<span class="token punctuation">,</span>
  computeStyles<span class="token punctuation">,</span>
  applyStyles<span class="token punctuation">,</span>
  offset<span class="token punctuation">,</span>
  flip<span class="token punctuation">,</span>
  preventOverflow<span class="token punctuation">,</span>
  arrow<span class="token punctuation">,</span>
  hide<span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>默认的Modifiers中，拥有effect函数的有，<code>eventListeners</code>、<code>applyStyles</code>、<code>arrow</code>。先来看一下这三个Modifier的effect函数分别做了什么。</p> <ol><li><h5 id="eventlisteners"><a href="#eventlisteners" class="header-anchor">#</a> eventListeners</h5></li></ol> <p>在前面已经看过了，这里就不做分析。该方法主要是注册监听器和取消监听器。</p> <ol start="2"><li><h5 id="applystyles"><a href="#applystyles" class="header-anchor">#</a> applyStyles</h5></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> state <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> initialStyles <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 初始化initial popper styles</span>
    <span class="token literal-property property">popper</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">position</span><span class="token operator">:</span> state<span class="token punctuation">.</span>options<span class="token punctuation">.</span>strategy<span class="token punctuation">,</span> <span class="token comment">// 默认为 absolute</span>
      <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token string">'0'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">top</span><span class="token operator">:</span> <span class="token string">'0'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">margin</span><span class="token operator">:</span> <span class="token string">'0'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 初始化 initial arrow</span>
    <span class="token literal-property property">arrow</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// reference</span>
    <span class="token literal-property property">reference</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 合并 popper style</span>
  Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>elements<span class="token punctuation">.</span>popper<span class="token punctuation">.</span>style<span class="token punctuation">,</span> initialStyles<span class="token punctuation">.</span>popper<span class="token punctuation">)</span><span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>styles <span class="token operator">=</span> initialStyles<span class="token punctuation">;</span>
  <span class="token comment">// 合并 arrow style 设置position</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>elements<span class="token punctuation">.</span>arrow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>elements<span class="token punctuation">.</span>arrow<span class="token punctuation">.</span>style<span class="token punctuation">,</span> initialStyles<span class="token punctuation">.</span>arrow<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// clearnUp Fn</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 取出element</span>
      <span class="token keyword">const</span> element <span class="token operator">=</span> state<span class="token punctuation">.</span>elements<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">//  取出 attribute</span>
      <span class="token keyword">const</span> attributes <span class="token operator">=</span> state<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token comment">// styleProperties</span>
      <span class="token keyword">const</span> styleProperties <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>
        state<span class="token punctuation">.</span>styles<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
          <span class="token operator">?</span> state<span class="token punctuation">.</span>styles<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
          <span class="token operator">:</span> initialStyles<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Set all values to an empty string to unset them</span>
      <span class="token keyword">const</span> style <span class="token operator">=</span> styleProperties<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">style<span class="token punctuation">,</span> property</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        style<span class="token punctuation">[</span>property<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> style<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// arrow is optional + virtual elements</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isHTMLElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">getNodeName</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>style<span class="token punctuation">,</span> style<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 移除apply的initalStyle</span>
      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">attribute</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        element<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>该方法针对 <code>popper</code>和<code>arrow</code>做了一些style样式的合并和删除操作</p> <ol start="3"><li><h5 id="arrow"><a href="#arrow" class="header-anchor">#</a> Arrow</h5></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Specifies the element to position as the arrow. This element must be a child of the popper element.</span>
<span class="token comment">// A string represents a CSS selector queried within the context of the popper element.</span>
<span class="token comment">// Popper will automatically pick up the following element (using the data-popper-arrow attribute) and position it:</span>
<span class="token comment">// arrow type = Element | String</span>
<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> state<span class="token punctuation">,</span> options <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> <span class="token literal-property property">element</span><span class="token operator">:</span> arrowElement <span class="token operator">=</span> <span class="token string">'[data-popper-arrow]'</span> <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
  <span class="token comment">// 若没有arrowElement return</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>arrowElement <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// CSS selector</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> arrowElement <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    arrowElement <span class="token operator">=</span> state<span class="token punctuation">.</span>elements<span class="token punctuation">.</span>popper<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>arrowElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>arrowElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">contains</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>elements<span class="token punctuation">.</span>popper<span class="token punctuation">,</span> arrowElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// arrow 设置</span>
  state<span class="token punctuation">.</span>elements<span class="token punctuation">.</span>arrow <span class="token operator">=</span> arrowElement<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过这三个 <code>effect</code>，可以发现，<code>eventListeners</code>主要是设置<code>update</code>更新机制，applyStyles主要是 merge <code>refenerce</code>、<code>popper</code>、<code>arrow</code>的style。<code>Arrow</code>主要是设置小箭头的elements。</p> <h4 id="modifier-fn"><a href="#modifier-fn" class="header-anchor">#</a> Modifier[fn]</h4> <p>除<code>eventListeners</code>这个Modifier 之外，其他的基本上都有fn方法，逐个攻破！</p> <p>这里要注意的是，Modifier执行顺序是不可打乱的，在<code>setOptions</code>时，有这样一段代码,将默认的<code>modifiers</code>放置到了最前面。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// defaultModifiers 是默认的Modifiers</span>
<span class="token keyword">const</span> orderedModifiers <span class="token operator">=</span> <span class="token function">orderModifiers</span><span class="token punctuation">(</span>
          <span class="token function">mergeByName</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>defaultModifiers<span class="token punctuation">,</span> <span class="token operator">...</span>state<span class="token punctuation">.</span>options<span class="token punctuation">.</span>modifiers<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol><li><h5 id="popperoffsets"><a href="#popperoffsets" class="header-anchor">#</a> popperOffsets</h5></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">popperOffsets</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> state<span class="token punctuation">,</span> name <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// offsets 是popper需要被正确放置在参考元素附近的实际位置，</span>
  state<span class="token punctuation">.</span>modifiersData<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">computeOffsets</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">reference</span><span class="token operator">:</span> state<span class="token punctuation">.</span>rects<span class="token punctuation">.</span>reference<span class="token punctuation">,</span>
    <span class="token literal-property property">element</span><span class="token operator">:</span> state<span class="token punctuation">.</span>rects<span class="token punctuation">.</span>popper<span class="token punctuation">,</span>
    <span class="token literal-property property">strategy</span><span class="token operator">:</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">placement</span><span class="token operator">:</span> state<span class="token punctuation">.</span>placement<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">computeOffsets</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  reference<span class="token punctuation">,</span>
  element<span class="token punctuation">,</span>
  placement<span class="token punctuation">,</span>
<span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 获取 placement  'top' | 'bottom' | 'left' | 'right';</span>
  <span class="token keyword">const</span> basePlacement <span class="token operator">=</span> placement <span class="token operator">?</span> <span class="token function">getBasePlacement</span><span class="token punctuation">(</span>placement<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取方位 'start' | 'end';</span>
  <span class="token keyword">const</span> variation <span class="token operator">=</span> placement <span class="token operator">?</span> <span class="token function">getVariation</span><span class="token punctuation">(</span>placement<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// 基准坐标 x 可以理解为 距离页面左边的宽度 + reference宽度 / 2 - (popper的宽度 / 2)</span>
  <span class="token keyword">const</span> commonX <span class="token operator">=</span> reference<span class="token punctuation">.</span>x <span class="token operator">+</span> reference<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">-</span> element<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token comment">// 基准坐标 y 可以理解为 距离页面上边的宽度 + reference高度 / 2 - (popper的高度 / 2)</span>
  <span class="token keyword">const</span> commonY <span class="token operator">=</span> reference<span class="token punctuation">.</span>y <span class="token operator">+</span> reference<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">-</span> element<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token comment">// 基本为 reference 中心点 向左上偏移 [element.width / 2,element.height / 2];</span>
  <span class="token keyword">let</span> offsets<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>basePlacement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">top</span><span class="token operator">:</span>
      offsets <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">x</span><span class="token operator">:</span> commonX<span class="token punctuation">,</span>
        <span class="token literal-property property">y</span><span class="token operator">:</span> reference<span class="token punctuation">.</span>y <span class="token operator">-</span> element<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">bottom</span><span class="token operator">:</span>
      offsets <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">x</span><span class="token operator">:</span> commonX<span class="token punctuation">,</span>
        <span class="token literal-property property">y</span><span class="token operator">:</span> reference<span class="token punctuation">.</span>y <span class="token operator">+</span> reference<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">right</span><span class="token operator">:</span>
      offsets <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">x</span><span class="token operator">:</span> reference<span class="token punctuation">.</span>x <span class="token operator">+</span> reference<span class="token punctuation">.</span>width<span class="token punctuation">,</span>
        <span class="token literal-property property">y</span><span class="token operator">:</span> commonY<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">left</span><span class="token operator">:</span>
      offsets <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">x</span><span class="token operator">:</span> reference<span class="token punctuation">.</span>x <span class="token operator">-</span> element<span class="token punctuation">.</span>width<span class="token punctuation">,</span>
        <span class="token literal-property property">y</span><span class="token operator">:</span> commonY<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      offsets <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">x</span><span class="token operator">:</span> reference<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
        <span class="token literal-property property">y</span><span class="token operator">:</span> reference<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> mainAxis <span class="token operator">=</span> basePlacement
    <span class="token operator">?</span> <span class="token function">getMainAxisFromPlacement</span><span class="token punctuation">(</span>basePlacement<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mainAxis <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> len <span class="token operator">=</span> mainAxis <span class="token operator">===</span> <span class="token string">'y'</span> <span class="token operator">?</span> <span class="token string">'height'</span> <span class="token operator">:</span> <span class="token string">'width'</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>variation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token literal-property property">start</span><span class="token operator">:</span>
        offsets<span class="token punctuation">[</span>mainAxis<span class="token punctuation">]</span> <span class="token operator">=</span>
          offsets<span class="token punctuation">[</span>mainAxis<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token punctuation">(</span>reference<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">-</span> element<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token literal-property property">end</span><span class="token operator">:</span>
        offsets<span class="token punctuation">[</span>mainAxis<span class="token punctuation">]</span> <span class="token operator">=</span>
          offsets<span class="token punctuation">[</span>mainAxis<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>reference<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">-</span> element<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> offsets<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码解释起来看上去不是很好理解，看图</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/abb7f98694d8401e834b5e10322fddd4~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p> <p><code>offsets</code> 先会根据<code>basePlacement</code>计算出 4种情况的定位 <strong>基点。</strong></p> <blockquote><p>基点就是 popper element 左上角的那个点，这也是为什么offset看上去奇奇怪怪的。</p></blockquote> <p>假设popper 的 width 和 height 均为 0。 是不是就更容易理解了</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5f121d8f6af6412588d18c09b0395689~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p> <p>然后根据 <code>mainAxis</code>和<code>variation</code>主轴(x | y)计算 <code>start | end</code> 的偏移量 。</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f3f48da7e9e44a358d04670eaaa58d88~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p> <p>最终生成 <code>offsets:{x:number,y:number}</code>，基点坐标，将它存储进入 <code>modifiersData</code>中。字段名为 <code>popperOffsets</code>。</p> <ol start="2"><li><h5 id="computestyles"><a href="#computestyles" class="header-anchor">#</a> computeStyles</h5></li></ol> <p>主要计算 <code>popper</code>、<code>arrow</code>的 style 样式，开启GPU加速(使用transform)，一些误差的磨平。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">computeStyles</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> state<span class="token punctuation">,</span> options <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token comment">// gpu加速 默认开启</span>
    gpuAcceleration <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 自适应 默认开启</span>
    adaptive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// defaults to use builtin `roundOffsetsByDPR`</span>
    roundOffsets <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
  
  <span class="token keyword">const</span> commonStyles <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// top、bottom、start、end</span>
    <span class="token literal-property property">placement</span><span class="token operator">:</span> <span class="token function">getBasePlacement</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>placement<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// start、end</span>
    <span class="token literal-property property">variation</span><span class="token operator">:</span> <span class="token function">getVariation</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>placement<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// element</span>
    <span class="token literal-property property">popper</span><span class="token operator">:</span> state<span class="token punctuation">.</span>elements<span class="token punctuation">.</span>popper<span class="token punctuation">,</span>
    <span class="token comment">// update中生成的 rect</span>
    <span class="token literal-property property">popperRect</span><span class="token operator">:</span> state<span class="token punctuation">.</span>rects<span class="token punctuation">.</span>popper<span class="token punctuation">,</span>
    <span class="token comment">// gpu加速</span>
    gpuAcceleration<span class="token punctuation">,</span>
    <span class="token literal-property property">isFixed</span><span class="token operator">:</span> state<span class="token punctuation">.</span>options<span class="token punctuation">.</span>strategy <span class="token operator">===</span> <span class="token string">'fixed'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 在popperOffsets中生成的</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>modifiersData<span class="token punctuation">.</span>popperOffsets <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state<span class="token punctuation">.</span>styles<span class="token punctuation">.</span>popper <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>state<span class="token punctuation">.</span>styles<span class="token punctuation">.</span>popper<span class="token punctuation">,</span>
      <span class="token operator">...</span><span class="token function">mapToStyles</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token operator">...</span>commonStyles<span class="token punctuation">,</span>
        <span class="token literal-property property">offsets</span><span class="token operator">:</span> state<span class="token punctuation">.</span>modifiersData<span class="token punctuation">.</span>popperOffsets<span class="token punctuation">,</span>
        <span class="token literal-property property">position</span><span class="token operator">:</span> state<span class="token punctuation">.</span>options<span class="token punctuation">.</span>strategy<span class="token punctuation">,</span>
        adaptive<span class="token punctuation">,</span>
        roundOffsets<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>modifiersData<span class="token punctuation">.</span>arrow <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state<span class="token punctuation">.</span>styles<span class="token punctuation">.</span>arrow <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>state<span class="token punctuation">.</span>styles<span class="token punctuation">.</span>arrow<span class="token punctuation">,</span>
      <span class="token operator">...</span><span class="token function">mapToStyles</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token operator">...</span>commonStyles<span class="token punctuation">,</span>
        <span class="token literal-property property">offsets</span><span class="token operator">:</span> state<span class="token punctuation">.</span>modifiersData<span class="token punctuation">.</span>arrow<span class="token punctuation">,</span>
        <span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">adaptive</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        roundOffsets<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  state<span class="token punctuation">.</span>attributes<span class="token punctuation">.</span>popper <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>state<span class="token punctuation">.</span>attributes<span class="token punctuation">.</span>popper<span class="token punctuation">,</span>
    <span class="token string-property property">'data-popper-placement'</span><span class="token operator">:</span> state<span class="token punctuation">.</span>placement<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">mapToStyles</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>popper<span class="token punctuation">,</span>popperRect<span class="token punctuation">,</span>placement<span class="token punctuation">,</span>variation<span class="token punctuation">,</span>offsets<span class="token punctuation">,</span>position<span class="token punctuation">,</span>gpuAcceleration<span class="token punctuation">,</span>adaptive<span class="token punctuation">,</span>roundOffsets<span class="token punctuation">,</span>isFixed<span class="token punctuation">,</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
  <span class="token comment">// offsets 来自于 popperOffsets 中生成</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">}</span> <span class="token operator">=</span> offsets<span class="token punctuation">;</span>
  <span class="token keyword">const</span> hasX <span class="token operator">=</span> offsets<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> hasY <span class="token operator">=</span> offsets<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token literal-property property">sideX</span><span class="token operator">:</span> string <span class="token operator">=</span> left<span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token literal-property property">sideY</span><span class="token operator">:</span> string <span class="token operator">=</span> top<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token literal-property property">win</span><span class="token operator">:</span> Window <span class="token operator">=</span> window<span class="token punctuation">;</span>
  <span class="token comment">// 自适应处理逻辑 存在一些 style的变换</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>adaptive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ... some code </span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 经过自适应处理过后的style</span>
  <span class="token keyword">const</span> commonStyles <span class="token operator">=</span> <span class="token punctuation">{</span>
    position<span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token punctuation">(</span>adaptive <span class="token operator">&amp;&amp;</span> unsetSides<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 默认为 true 自定义取消误差函数</span>
  <span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span>
    <span class="token keyword">typeof</span> roundOffsets <span class="token operator">===</span> <span class="token string">'function'</span>
      <span class="token operator">?</span> <span class="token function">roundOffsets</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 取消误差 因为不同分辨率下可能会存在一些误差而导致渲染错位，通常会有&lt;1px的误差</span>
  <span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span>
    roundOffsets <span class="token operator">===</span> <span class="token boolean">true</span>
      <span class="token operator">?</span> <span class="token function">roundOffsetsByDPR</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果开启gpu加速的话 使用transform</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>gpuAcceleration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>commonStyles<span class="token punctuation">,</span>
      <span class="token punctuation">[</span>sideY<span class="token punctuation">]</span><span class="token operator">:</span> hasY <span class="token operator">?</span> <span class="token string">'0'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span>sideX<span class="token punctuation">]</span><span class="token operator">:</span> hasX <span class="token operator">?</span> <span class="token string">'0'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      <span class="token comment">// Layer acceleration can disable subpixel rendering which causes slightly</span>
      <span class="token comment">// blurry text on low PPI displays, so we want to use 2D transforms</span>
      <span class="token comment">// instead</span>
      <span class="token literal-property property">transform</span><span class="token operator">:</span>
        <span class="token punctuation">(</span>win<span class="token punctuation">.</span>devicePixelRatio <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">1</span>
          <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translate(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>y<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px)</span><span class="token template-punctuation string">`</span></span>
          <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translate3d(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>y<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px, 0)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 不开启gpu加速返回得结果</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>commonStyles<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>sideY<span class="token punctuation">]</span><span class="token operator">:</span> hasY <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>y<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>sideX<span class="token punctuation">]</span><span class="token operator">:</span> hasX <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li><h5 id="applystyles-2"><a href="#applystyles-2" class="header-anchor">#</a> applyStyles</h5></li></ol> <p>将 <code>popper</code>、<code>arrow</code>、<code>reference</code>等原有的 style 和 attribute 与 <code>computeSytles</code> 中计算出的 style 样式进行合并。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">applyStyles</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> state <span class="token punctuation">}</span><span class="token operator">:</span> ModifierArguments<span class="token operator">&lt;</span><span class="token punctuation">{</span><span class="token operator">||</span><span class="token punctuation">}</span><span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 取出 reference、 popper、arrow 设置 style、attributes等</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> style <span class="token operator">=</span> state<span class="token punctuation">.</span>styles<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> attributes <span class="token operator">=</span> state<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> element <span class="token operator">=</span> state<span class="token punctuation">.</span>elements<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// arrow is optional + virtual elements</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isHTMLElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">getNodeName</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Flow doesn't support to extend this property, but it's the most</span>
    <span class="token comment">// effective way to apply styles to an HTMLElement</span>
    <span class="token comment">// $FlowFixMe[cannot-write]</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>style<span class="token punctuation">,</span> style<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 针对 attribute 特殊处理</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> attributes<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        element<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        element<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value <span class="token operator">===</span> <span class="token boolean">true</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li><h5 id="offsets"><a href="#offsets" class="header-anchor">#</a> Offsets</h5></li></ol> <p><strong>注：这里的offsets指的是用户自定义的一些偏移量，而不是计算得出的 <code>popperOffsets</code>。</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">offset</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> state<span class="token punctuation">,</span> options<span class="token punctuation">,</span> name <span class="token punctuation">}</span><span class="token operator">:</span> ModifierArguments<span class="token operator">&lt;</span>Options<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// options传入的参数 [0,0] 可以理解为用户自定义额外的偏移量</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> offset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
  <span class="token comment">// 由于接下来的溢出检测，自动切换位置可能会需要其他方向的偏移量，所以这边一次性所有方位全部生成，而避免了每次计算，每次生成。</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> placements<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> placement</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据placements生成 每个方位的偏移量</span>
    acc<span class="token punctuation">[</span>placement<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">distanceAndSkiddingToXY</span><span class="token punctuation">(</span>placement<span class="token punctuation">,</span> state<span class="token punctuation">.</span>rects<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> acc<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span> data<span class="token punctuation">[</span>state<span class="token punctuation">.</span>placement<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>modifiersData<span class="token punctuation">.</span>popperOffsets <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state<span class="token punctuation">.</span>modifiersData<span class="token punctuation">.</span>popperOffsets<span class="token punctuation">.</span>x <span class="token operator">+=</span> x<span class="token punctuation">;</span>
    state<span class="token punctuation">.</span>modifiersData<span class="token punctuation">.</span>popperOffsets<span class="token punctuation">.</span>y <span class="token operator">+=</span> y<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 更新 modifiersData popperOffsets</span>
  state<span class="token punctuation">.</span>modifiersData<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="5"><li><h5 id="flip"><a href="#flip" class="header-anchor">#</a> flip</h5></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">flip</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> state<span class="token punctuation">,</span> options<span class="token punctuation">,</span> name <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// flip skip    </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>modifiersData<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>_skip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// </span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">mainAxis</span><span class="token operator">:</span> checkMainAxis <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">altAxis</span><span class="token operator">:</span> checkAltAxis <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token comment">// 默认可供尝试的placements</span>
        <span class="token literal-property property">fallbackPlacements</span><span class="token operator">:</span> specifiedFallbackPlacements<span class="token punctuation">,</span>
        <span class="token comment">// 会对boundary边界进行虚拟填充</span>
        padding<span class="token punctuation">,</span>
        <span class="token comment">// popper</span>
        boundary<span class="token punctuation">,</span>
        <span class="token comment">// reference</span>
        rootBoundary<span class="token punctuation">,</span>
        <span class="token comment">// arrow</span>
        altBoundary<span class="token punctuation">,</span>
        <span class="token comment">// top-start =&gt; top-end 尝试翻转变化</span>
        flipVariations <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        allowedAutoPlacements<span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
    <span class="token comment">// custom placement??</span>
    <span class="token keyword">const</span> preferredPlacement <span class="token operator">=</span> state<span class="token punctuation">.</span>options<span class="token punctuation">.</span>placement<span class="token punctuation">;</span>
    <span class="token comment">// 'top-start' =&gt; 'top'</span>
    <span class="token keyword">const</span> basePlacement <span class="token operator">=</span> <span class="token function">getBasePlacement</span><span class="token punctuation">(</span>preferredPlacement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> isBasePlacement <span class="token operator">=</span> basePlacement <span class="token operator">===</span> preferredPlacement<span class="token punctuation">;</span>
    <span class="token comment">// 获取 当发生溢出时，可供尝试的Placements，默认情况下应该为 specifiedFallbackPlacements，</span>
    <span class="token comment">//若没有 specifiedFallbackPlacements 则根据placement来生成fallbackPlacements</span>
    <span class="token keyword">const</span> fallbackPlacements <span class="token operator">=</span>
        specifiedFallbackPlacements <span class="token operator">||</span>
        <span class="token punctuation">(</span>isBasePlacement <span class="token operator">||</span> <span class="token operator">!</span>flipVariations <span class="token operator">?</span>
            <span class="token punctuation">[</span><span class="token function">getOppositePlacement</span><span class="token punctuation">(</span>preferredPlacement<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">:</span>
            <span class="token function">getExpandedFallbackPlacements</span><span class="token punctuation">(</span>preferredPlacement<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 生成的placements</span>
    <span class="token keyword">const</span> placements <span class="token operator">=</span> <span class="token punctuation">[</span>preferredPlacement<span class="token punctuation">,</span> <span class="token operator">...</span>fallbackPlacements<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> placement</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> acc<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
                <span class="token comment">// 当placement为 'auto'时，自动生成一个可能能用的placement</span>
                <span class="token function">getBasePlacement</span><span class="token punctuation">(</span>placement<span class="token punctuation">)</span> <span class="token operator">===</span> auto <span class="token operator">?</span>
                <span class="token function">computeAutoPlacement</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                    placement<span class="token punctuation">,</span>
                    boundary<span class="token punctuation">,</span>
                    rootBoundary<span class="token punctuation">,</span>
                    padding<span class="token punctuation">,</span>
                    flipVariations<span class="token punctuation">,</span>
                    allowedAutoPlacements<span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">:</span>
                placement
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><a href="https://popper.js.org/docs/v2/modifiers/flip/#fallbackplacements" target="_blank" rel="noopener noreferrer">fallbackPlacements有关的一些说明<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，假设我们原有的<code>placement</code>设置为<code>button</code>，当没有足够的空间来容纳它时，会使用<code>fallbackPlacements</code>中的参数来进行尝试。<code>pacements</code> 有下面三种情况：</p> <ul><li><code>specifiedFallbackPlacements</code>参数，则直接使用参数，</li> <li>是<code>basePlacement(top | left | right | bottom)</code>，则会取反，例如 原来是<code>top</code>，取反会是 <code>bottom</code></li> <li><code>是 top-start</code>，会先尝试 <code>top-end</code>、<code>bottom-start</code>、<code>bottom-end</code>这三种情况。</li> <li>是 <code>auto</code>，则执行 <code>computeAutoPlacement</code>进行计算。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">const</span> referenceRect <span class="token operator">=</span> state<span class="token punctuation">.</span>rects<span class="token punctuation">.</span>reference<span class="token punctuation">;</span>
    <span class="token keyword">const</span> popperRect <span class="token operator">=</span> state<span class="token punctuation">.</span>rects<span class="token punctuation">.</span>popper<span class="token punctuation">;</span>
    <span class="token keyword">const</span> checksMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> makeFallbackChecks <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> firstFittingPlacement <span class="token operator">=</span> placements<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 开始生成checksMap</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> placements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> placement <span class="token operator">=</span> placements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> basePlacement <span class="token operator">=</span> <span class="token function">getBasePlacement</span><span class="token punctuation">(</span>placement<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> isStartVariation <span class="token operator">=</span> <span class="token function">getVariation</span><span class="token punctuation">(</span>placement<span class="token punctuation">)</span> <span class="token operator">===</span> start<span class="token punctuation">;</span>
        <span class="token comment">// 方向 x | y</span>
        <span class="token keyword">const</span> isVertical <span class="token operator">=</span> <span class="token punctuation">[</span>top<span class="token punctuation">,</span> bottom<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>basePlacement<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 检测溢出 </span>
        <span class="token keyword">const</span> overflow <span class="token operator">=</span> <span class="token function">detectOverflow</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            placement<span class="token punctuation">,</span>
            boundary<span class="token punctuation">,</span>
            rootBoundary<span class="token punctuation">,</span>
            altBoundary<span class="token punctuation">,</span>
            padding<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里的是 经过 <code>detectOverflow</code>函数，生成了 <code>overflow</code>，利用 <code>overflow</code> 来判断可用的<code>placement</code>。看一下 <code>detectOverflow</code>是如何检测溢出的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">detectOverflow</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span>option</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    placement <span class="token operator">=</span> state<span class="token punctuation">.</span>placement<span class="token punctuation">,</span>
    boundary <span class="token operator">=</span> clippingParents<span class="token punctuation">,</span>
    rootBoundary <span class="token operator">=</span> viewport<span class="token punctuation">,</span>
    <span class="token comment">// flip调用时，没有传入elementContext，为默认值</span>
    elementContext <span class="token operator">=</span> popper<span class="token punctuation">,</span>
    <span class="token comment">// true =&gt; reference || false =&gt; popper</span>
    altBoundary <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token comment">// padding 检测距离，用户传入参数</span>
    padding <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
  <span class="token comment">// 根据padding和 basePlacements生成 </span>
  <span class="token comment">// paddingObject，默认是{top:0,left:0,right:0,bottom:0}</span>
  <span class="token comment">// 假设padding = 10,则为 {top:10,left:10,right:10,bottom:10}</span>
  <span class="token keyword">const</span> paddingObject <span class="token operator">=</span> <span class="token function">mergePaddingObject</span><span class="token punctuation">(</span>
    <span class="token keyword">typeof</span> padding <span class="token operator">!==</span> <span class="token string">'number'</span>
      <span class="token operator">?</span> padding
      <span class="token operator">:</span> <span class="token function">expandToHashMap</span><span class="token punctuation">(</span>padding<span class="token punctuation">,</span> basePlacements<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// altContext 在flip调用时 默认为 reference</span>
  <span class="token keyword">const</span> altContext <span class="token operator">=</span> elementContext <span class="token operator">===</span> popper <span class="token operator">?</span> reference <span class="token operator">:</span> popper<span class="token punctuation">;</span>
  <span class="token keyword">const</span> popperRect <span class="token operator">=</span> state<span class="token punctuation">.</span>rects<span class="token punctuation">.</span>popper<span class="token punctuation">;</span>
  <span class="token comment">// element 默认为 popper</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> state<span class="token punctuation">.</span>elements<span class="token punctuation">[</span>altBoundary <span class="token operator">?</span> altContext <span class="token operator">:</span> elementContext<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 生成一个clippingclient {width,height,x,y} // 这个clippingclientRect默认情况下指的是父节点的滚动区域大小或者是 viewport大小</span>
  <span class="token comment">// 原有的注释：Gets the maximum area that the element is visible in due to any number of clipping parents</span>
  <span class="token keyword">const</span> clippingClientRect <span class="token operator">=</span> <span class="token function">getClippingRect</span><span class="token punctuation">(</span>
    <span class="token function">isElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
      <span class="token operator">?</span> element
      <span class="token operator">:</span> element<span class="token punctuation">.</span>contextElement <span class="token operator">||</span> <span class="token function">getDocumentElement</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>elements<span class="token punctuation">.</span>popper<span class="token punctuation">)</span><span class="token punctuation">,</span>
    boundary<span class="token punctuation">,</span> <span class="token comment">// clippingParents</span>
    rootBoundary <span class="token comment">// viewport</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 浏览器中的 真正大小, getBoundingClientRect函数重写了element. getBoundingClientRect，其中对页面的缩放及一些element.getBoundingClientRect错误情况做了容错处理。这里可以直接理解为element.getBoundingClientRect的返回值</span>
  <span class="token keyword">const</span> referenceClientRect <span class="token operator">=</span> <span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>elements<span class="token punctuation">.</span>reference<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// computeOffsets 在popperOffsets中用到过，这里就不做说明了，会生成一个基点坐标</span>
  <span class="token keyword">const</span> popperOffsets <span class="token operator">=</span> <span class="token function">computeOffsets</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">reference</span><span class="token operator">:</span> referenceClientRect<span class="token punctuation">,</span>
    <span class="token literal-property property">element</span><span class="token operator">:</span> popperRect<span class="token punctuation">,</span>
    <span class="token literal-property property">strategy</span><span class="token operator">:</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span>
    placement<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  根据得到的基点坐标，生成新的 popperClientRect
  <span class="token keyword">const</span> popperClientRect <span class="token operator">=</span> <span class="token function">rectToClientRect</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token operator">...</span>popperRect<span class="token punctuation">,</span>
    <span class="token operator">...</span>popperOffsets<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// elementClientRect默认值为 popperClientRect</span>
  <span class="token keyword">const</span> elementClientRect <span class="token operator">=</span>
    elementContext <span class="token operator">===</span> popper <span class="token operator">?</span> popperClientRect <span class="token operator">:</span> referenceClientRect<span class="token punctuation">;</span>
  <span class="token comment">// 四个方向检测是否有溢出，如果有溢出的话，例如：top:10,</span>
  <span class="token keyword">const</span> overflowOffsets <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">top</span><span class="token operator">:</span> clippingClientRect<span class="token punctuation">.</span>top <span class="token operator">-</span> elementClientRect<span class="token punctuation">.</span>top <span class="token operator">+</span> paddingObject<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
    <span class="token literal-property property">bottom</span><span class="token operator">:</span>
      elementClientRect<span class="token punctuation">.</span>bottom <span class="token operator">-</span>
      clippingClientRect<span class="token punctuation">.</span>bottom <span class="token operator">+</span>
      paddingObject<span class="token punctuation">.</span>bottom<span class="token punctuation">,</span>
    <span class="token literal-property property">left</span><span class="token operator">:</span> clippingClientRect<span class="token punctuation">.</span>left <span class="token operator">-</span> elementClientRect<span class="token punctuation">.</span>left <span class="token operator">+</span> paddingObject<span class="token punctuation">.</span>left<span class="token punctuation">,</span>
    <span class="token literal-property property">right</span><span class="token operator">:</span>
      elementClientRect<span class="token punctuation">.</span>right <span class="token operator">-</span> clippingClientRect<span class="token punctuation">.</span>right <span class="token operator">+</span> paddingObject<span class="token punctuation">.</span>right<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
   <span class="token comment">// 获取在offsets生成的offsetData</span>
  <span class="token keyword">const</span> offsetData <span class="token operator">=</span> state<span class="token punctuation">.</span>modifiersData<span class="token punctuation">.</span>offset<span class="token punctuation">;</span>
  <span class="token comment">// Offsets can be applied only to the popper element</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>elementContext <span class="token operator">===</span> popper <span class="token operator">&amp;&amp;</span> offsetData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> offset <span class="token operator">=</span> offsetData<span class="token punctuation">[</span>placement<span class="token punctuation">]</span><span class="token punctuation">;</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>overflowOffsets<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> multiply <span class="token operator">=</span> <span class="token punctuation">[</span>right<span class="token punctuation">,</span> bottom<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> axis <span class="token operator">=</span> <span class="token punctuation">[</span>top<span class="token punctuation">,</span> bottom<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">'y'</span> <span class="token operator">:</span> <span class="token string">'x'</span><span class="token punctuation">;</span>
      overflowOffsets<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> offset<span class="token punctuation">[</span>axis<span class="token punctuation">]</span> <span class="token operator">*</span> multiply<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> overflowOffsets<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码有点复杂，来分析一下<code>detectOverflow</code>函数做了什么</p> <ol><li>根据 <code>padding</code> 生成 <code>paddingObject</code>，</li> <li>判断是检测 <code>popper</code>还是 <code>reference</code>，生成<code>altContext</code></li> <li>根据<code>altContext</code>，生成 <code>clippingClientRect</code>,该变量默认情况下是父节点滚动区域的大小或者 viewport的可视区域大小,为<code>altContext</code>可见的最大区域</li> <li><code>elementClientRect</code> 为 <strong>此时此刻</strong>，<code>reference.getBoundingClientRect()</code>或者 <code>popperClientRect</code></li> <li>生成 <code>overflowOffsets</code>，举例：<code>top</code>为 <code>clippingClientRect.top</code> - <code>elementClientRect.top</code> + <code>paddingObject.top</code>，正常情况下若可用为负数</li></ol> <p>最终，我们返回了<code>overflowOffsets</code>，它包含了4个方位是否有溢出的情况。目前，我们仅分析默认情况，传参情况暂不考虑。</p> <div class="language-js extra-class"><pre class="language-js"><code>        <span class="token comment">// 分区</span>
        <span class="token comment">// right:top-start、bottom-start</span>
        <span class="token comment">// left:top-end、bottom-end</span>
        <span class="token comment">// bottom:left-start、right-start</span>
        <span class="token comment">// top:left-end、right-end</span>
        <span class="token keyword">let</span> <span class="token literal-property property">mainVariationSide</span><span class="token operator">:</span> any <span class="token operator">=</span> isVertical <span class="token operator">?</span>
            <span class="token punctuation">(</span>isStartVariation <span class="token operator">?</span>
              <span class="token literal-property property">right</span> <span class="token operator">:</span>
              left <span class="token punctuation">)</span><span class="token operator">:</span>
            <span class="token punctuation">(</span>isStartVariation <span class="token operator">?</span>
              <span class="token literal-property property">bottom</span> <span class="token operator">:</span>
              top<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> len <span class="token operator">=</span> isVertical <span class="token operator">?</span> <span class="token string">'width'</span> <span class="token operator">:</span> <span class="token string">'height'</span><span class="token punctuation">;</span>
        <span class="token comment">// 若 reference width | height &gt; popper 取反向，没太想通为什么要取反向</span>
        <span class="token comment">// 刚刚得到的right会变成 left</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>referenceRect<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">&gt;</span> popperRect<span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mainVariationSide <span class="token operator">=</span> <span class="token function">getOppositePlacement</span><span class="token punctuation">(</span>mainVariationSide<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">const</span> <span class="token literal-property property">altVariationSide</span><span class="token operator">:</span> any <span class="token operator">=</span> <span class="token function">getOppositePlacement</span><span class="token punctuation">(</span>mainVariationSide<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> checks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 这里需要注意正数为不可用，负数|| 0 为可用,还有空间</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>checkMainAxis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            checks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>overflow<span class="token punctuation">[</span>basePlacement<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>checkAltAxis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            checks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
                overflow<span class="token punctuation">[</span>mainVariationSide<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">,</span>
                overflow<span class="token punctuation">[</span>altVariationSide<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">0</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 若有一个可用的位置</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>checks<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">check</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> check<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            firstFittingPlacement <span class="token operator">=</span> placement<span class="token punctuation">;</span>
            makeFallbackChecks <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        checksMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>placement<span class="token punctuation">,</span> checks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果没有可用的placement</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>makeFallbackChecks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// `2` may be desired in some cases – research later</span>
        <span class="token keyword">const</span> numberOfChecks <span class="token operator">=</span> flipVariations <span class="token operator">?</span> <span class="token number">3</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> numberOfChecks<span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> fittingPlacement <span class="token operator">=</span> placements<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">placement</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> checks <span class="token operator">=</span> checksMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>placement<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>checks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> checks<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">check</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> check<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fittingPlacement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                firstFittingPlacement <span class="token operator">=</span> fittingPlacement<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 若placement与预设的不同，则_skip为true。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>placement <span class="token operator">!==</span> firstFittingPlacement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        state<span class="token punctuation">.</span>modifiersData<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>_skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        state<span class="token punctuation">.</span>placement <span class="token operator">=</span> firstFittingPlacement<span class="token punctuation">;</span>
        state<span class="token punctuation">.</span>reset <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>Flip 是这样，整体执行流程大致为，设置一些<code>placements</code>，检测<code>popper</code>四个方向，根据<code>placements</code>和<code>overflowOffsets</code>来推算哪个placements可以使用，如果某一个可以使用，结束退出函数。</p> <ol start="6"><li><h5 id="preventoverflow"><a href="#preventoverflow" class="header-anchor">#</a> preventOverflow</h5></li></ol> <p>这部分实在是懒得写了，QAQ。简单介绍一下他的作用，计算出reference在什么情况下应该算溢出，然后记录下这个值，以便后面使用</p> <ol start="7"><li><h5 id="arrow-2"><a href="#arrow-2" class="header-anchor">#</a> Arrow</h5></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">arrow</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> state<span class="token punctuation">,</span> name<span class="token punctuation">,</span> options <span class="token punctuation">}</span><span class="token operator">:</span> ModifierArguments<span class="token operator">&lt;</span>Options<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// </span>
  <span class="token keyword">const</span> arrowElement <span class="token operator">=</span> state<span class="token punctuation">.</span>elements<span class="token punctuation">.</span>arrow<span class="token punctuation">;</span>
  <span class="token comment">// </span>
  <span class="token keyword">const</span> popperOffsets <span class="token operator">=</span> state<span class="token punctuation">.</span>modifiersData<span class="token punctuation">.</span>popperOffsets<span class="token punctuation">;</span>
  <span class="token comment">// top/bottom/left/right</span>
  <span class="token keyword">const</span> basePlacement <span class="token operator">=</span> <span class="token function">getBasePlacement</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>placement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// top/bottom =&gt; x left/right =&gt; y</span>
  <span class="token keyword">const</span> axis <span class="token operator">=</span> <span class="token function">getMainAxisFromPlacement</span><span class="token punctuation">(</span>basePlacement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> isVertical <span class="token operator">=</span> <span class="token punctuation">[</span>left<span class="token punctuation">,</span> right<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>basePlacement<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> len <span class="token operator">=</span> isVertical <span class="token operator">?</span> <span class="token string">'height'</span> <span class="token operator">:</span> <span class="token string">'width'</span><span class="token punctuation">;</span>
  <span class="token comment">// 若无arrow元素或者 无popper的offset</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>arrowElement <span class="token operator">||</span> <span class="token operator">!</span>popperOffsets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 边距</span>
  <span class="token keyword">const</span> paddingObject <span class="token operator">=</span> <span class="token function">toPaddingObject</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>padding<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> arrowRect <span class="token operator">=</span> <span class="token function">getLayoutRect</span><span class="token punctuation">(</span>arrowElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> minProp <span class="token operator">=</span> axis <span class="token operator">===</span> <span class="token string">'y'</span> <span class="token operator">?</span> top <span class="token operator">:</span> left<span class="token punctuation">;</span>
  <span class="token keyword">const</span> maxProp <span class="token operator">=</span> axis <span class="token operator">===</span> <span class="token string">'y'</span> <span class="token operator">?</span> bottom <span class="token operator">:</span> right<span class="token punctuation">;</span>
  <span class="token keyword">const</span> endDiff <span class="token operator">=</span>
    state<span class="token punctuation">.</span>rects<span class="token punctuation">.</span>reference<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">+</span>
    state<span class="token punctuation">.</span>rects<span class="token punctuation">.</span>reference<span class="token punctuation">[</span>axis<span class="token punctuation">]</span> <span class="token operator">-</span>
    popperOffsets<span class="token punctuation">[</span>axis<span class="token punctuation">]</span> <span class="token operator">-</span>
    state<span class="token punctuation">.</span>rects<span class="token punctuation">.</span>popper<span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> startDiff <span class="token operator">=</span> popperOffsets<span class="token punctuation">[</span>axis<span class="token punctuation">]</span> <span class="token operator">-</span> state<span class="token punctuation">.</span>rects<span class="token punctuation">.</span>reference<span class="token punctuation">[</span>axis<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> arrowOffsetParent <span class="token operator">=</span> <span class="token function">getOffsetParent</span><span class="token punctuation">(</span>arrowElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> clientSize <span class="token operator">=</span> arrowOffsetParent
    <span class="token operator">?</span> axis <span class="token operator">===</span> <span class="token string">'y'</span>
      <span class="token operator">?</span> arrowOffsetParent<span class="token punctuation">.</span>clientHeight <span class="token operator">||</span> <span class="token number">0</span>
      <span class="token operator">:</span> arrowOffsetParent<span class="token punctuation">.</span>clientWidth <span class="token operator">||</span> <span class="token number">0</span>
    <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> centerToReference <span class="token operator">=</span> endDiff <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">-</span> startDiff <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token comment">// Make sure the arrow doesn't overflow the popper if the center point is</span>
  <span class="token comment">// outside of the popper bounds</span>
  <span class="token keyword">const</span> min <span class="token operator">=</span> paddingObject<span class="token punctuation">[</span>minProp<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> max <span class="token operator">=</span> clientSize <span class="token operator">-</span> arrowRect<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">-</span> paddingObject<span class="token punctuation">[</span>maxProp<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> center <span class="token operator">=</span> clientSize <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">-</span> arrowRect<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> centerToReference<span class="token punctuation">;</span>
  <span class="token keyword">const</span> offset <span class="token operator">=</span> <span class="token function">within</span><span class="token punctuation">(</span>min<span class="token punctuation">,</span> center<span class="token punctuation">,</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Prevents breaking syntax highlighting...</span>
  <span class="token keyword">const</span> <span class="token literal-property property">axisProp</span><span class="token operator">:</span> string <span class="token operator">=</span> axis<span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>modifiersData<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>axisProp<span class="token punctuation">]</span><span class="token operator">:</span> offset<span class="token punctuation">,</span>
    <span class="token literal-property property">centerOffset</span><span class="token operator">:</span> offset <span class="token operator">-</span> center<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>计算出arrow的位置。
8.  ##### hide</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">hide</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> state<span class="token punctuation">,</span> name <span class="token punctuation">}</span><span class="token operator">:</span> ModifierArguments<span class="token operator">&lt;</span><span class="token punctuation">{</span><span class="token operator">||</span><span class="token punctuation">}</span><span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> referenceRect <span class="token operator">=</span> state<span class="token punctuation">.</span>rects<span class="token punctuation">.</span>reference<span class="token punctuation">;</span>
  <span class="token keyword">const</span> popperRect <span class="token operator">=</span> state<span class="token punctuation">.</span>rects<span class="token punctuation">.</span>popper<span class="token punctuation">;</span>
  <span class="token keyword">const</span> preventedOffsets <span class="token operator">=</span> state<span class="token punctuation">.</span>modifiersData<span class="token punctuation">.</span>preventOverflow<span class="token punctuation">;</span>
  <span class="token comment">// referenceOverflow是否溢出</span>
  <span class="token keyword">const</span> referenceOverflow <span class="token operator">=</span> <span class="token function">detectOverflow</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">elementContext</span><span class="token operator">:</span> <span class="token string">'reference'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// popper是否溢出</span>
  <span class="token keyword">const</span> popperAltOverflow <span class="token operator">=</span> <span class="token function">detectOverflow</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">altBoundary</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> referenceClippingOffsets <span class="token operator">=</span> <span class="token function">getSideOffsets</span><span class="token punctuation">(</span>
    referenceOverflow<span class="token punctuation">,</span>
    referenceRect
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> popperEscapeOffsets <span class="token operator">=</span> <span class="token function">getSideOffsets</span><span class="token punctuation">(</span>
    popperAltOverflow<span class="token punctuation">,</span>
    popperRect<span class="token punctuation">,</span>
    preventedOffsets
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> isReferenceHidden <span class="token operator">=</span> <span class="token function">isAnySideFullyClipped</span><span class="token punctuation">(</span>referenceClippingOffsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> hasPopperEscaped <span class="token operator">=</span> <span class="token function">isAnySideFullyClipped</span><span class="token punctuation">(</span>popperEscapeOffsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>modifiersData<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    referenceClippingOffsets<span class="token punctuation">,</span>
    popperEscapeOffsets<span class="token punctuation">,</span>
    isReferenceHidden<span class="token punctuation">,</span>
    hasPopperEscaped<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>attributes<span class="token punctuation">.</span>popper <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>state<span class="token punctuation">.</span>attributes<span class="token punctuation">.</span>popper<span class="token punctuation">,</span>
    <span class="token string-property property">'data-popper-reference-hidden'</span><span class="token operator">:</span> isReferenceHidden<span class="token punctuation">,</span>
    <span class="token string-property property">'data-popper-escaped'</span><span class="token operator">:</span> hasPopperEscaped<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>分别判断了，<code>reference</code> 和<code>popper</code>是否溢出，如果溢出的话，则hide。</p> <h3 id="end"><a href="#end" class="header-anchor">#</a> End</h3> <p>第二弹到此结束了，有关popper.js仅分为2篇，这是第2篇。该文章仅是我个人的一些理解，难免有一些不对的地方，欢迎大家批评指正！！！ 如果可以的话，占用你一些时间，帮我点个赞吧👍🏻👍🏻👍🏻👍🏻👍🏻👍🏻~</p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2022/5/26 21:52:47</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/rc-component/rc-tree-1.html" class="prev">
            rc-tree
          </a></span> <span class="next"><a href="/translation/CHIPS.html">
            Cookies Having Independent Partitioned State
          </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-6c8a9a73><li class="level-2" data-v-6c8a9a73><a href="/popper/2x.html#前言" class="sidebar-link reco-side-前言" data-v-6c8a9a73>前言</a></li><li class="level-2" data-v-6c8a9a73><a href="/popper/2x.html#基本逻辑" class="sidebar-link reco-side-基本逻辑" data-v-6c8a9a73>基本逻辑</a></li><li class="level-3" data-v-6c8a9a73><a href="/popper/2x.html#初始化" class="sidebar-link reco-side-初始化" data-v-6c8a9a73>初始化</a></li><li class="level-3" data-v-6c8a9a73><a href="/popper/2x.html#modifiers" class="sidebar-link reco-side-modifiers" data-v-6c8a9a73>Modifiers</a></li><li class="level-3" data-v-6c8a9a73><a href="/popper/2x.html#end" class="sidebar-link reco-side-end" data-v-6c8a9a73>End</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.bd205e11.js" defer></script><script src="/assets/js/3.eb454419.js" defer></script><script src="/assets/js/1.88cb3713.js" defer></script><script src="/assets/js/13.f9620b26.js" defer></script>
  </body>
</html>
