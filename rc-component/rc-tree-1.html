<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>antd Design tree下层组件 rc-tree 组件源码解析 | wun blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="berber/胜利 博客">
    <meta name="keywords" content="博客 berber1016的博客 个人博客">
    
    <link rel="preload" href="/assets/css/0.styles.a1050808.css" as="style"><link rel="preload" href="/assets/js/app.bd205e11.js" as="script"><link rel="preload" href="/assets/js/3.eb454419.js" as="script"><link rel="preload" href="/assets/js/1.88cb3713.js" as="script"><link rel="preload" href="/assets/js/16.2d1bbd9a.js" as="script"><link rel="prefetch" href="/assets/js/10.3cba73d9.js"><link rel="prefetch" href="/assets/js/11.7bcc9995.js"><link rel="prefetch" href="/assets/js/12.d5e2cbf8.js"><link rel="prefetch" href="/assets/js/13.f9620b26.js"><link rel="prefetch" href="/assets/js/14.8bb9cae3.js"><link rel="prefetch" href="/assets/js/15.c87439fe.js"><link rel="prefetch" href="/assets/js/17.b011aab8.js"><link rel="prefetch" href="/assets/js/18.8ca79c53.js"><link rel="prefetch" href="/assets/js/19.71f9f76d.js"><link rel="prefetch" href="/assets/js/20.79b68d49.js"><link rel="prefetch" href="/assets/js/21.cf8ce4ca.js"><link rel="prefetch" href="/assets/js/4.ba359ddf.js"><link rel="prefetch" href="/assets/js/5.b20330d0.js"><link rel="prefetch" href="/assets/js/6.d5e60b9f.js"><link rel="prefetch" href="/assets/js/7.545067f8.js"><link rel="prefetch" href="/assets/js/8.2001d7e5.js"><link rel="prefetch" href="/assets/js/9.3c349e38.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a1050808.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-06036f94><div data-v-06036f94><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-06036f94 data-v-06036f94><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4a1cf9c0 data-v-06036f94 data-v-06036f94><h3 class="title" data-v-4a1cf9c0 data-v-4a1cf9c0>wun blog</h3> <p class="description" data-v-4a1cf9c0 data-v-4a1cf9c0>berber/胜利 博客</p> <label id="box" class="inputBox" data-v-4a1cf9c0 data-v-4a1cf9c0><input type="password" value="" data-v-4a1cf9c0> <span data-v-4a1cf9c0>Konck! Knock!</span> <button data-v-4a1cf9c0>OK</button></label> <div class="footer" data-v-4a1cf9c0 data-v-4a1cf9c0><span data-v-4a1cf9c0><i class="iconfont reco-theme" data-v-4a1cf9c0></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4a1cf9c0>vuePress-theme-reco</a></span> <span data-v-4a1cf9c0><i class="iconfont reco-copyright" data-v-4a1cf9c0></i> <a data-v-4a1cf9c0><!---->
            
          <!---->
          2022
        </a></span></div></div> <div class="hide" data-v-06036f94><header class="navbar" data-v-06036f94><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">wun blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><a href="https://github.com/berber1016" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://juejin.cn/user/1714893868770846" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://berber1016.github.io/typescript-eslint-chinese/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  typescript-eslint 翻译
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-06036f94></div> <aside class="sidebar" data-v-06036f94><div class="personal-info-wrapper" data-v-9487530a data-v-06036f94><!----> <!----> <div class="num" data-v-9487530a><div data-v-9487530a><h3 data-v-9487530a>9</h3> <h6 data-v-9487530a>文章</h6></div> <div data-v-9487530a><h3 data-v-9487530a>0</h3> <h6 data-v-9487530a>标签</h6></div></div> <ul class="social-links" data-v-9487530a></ul> <hr data-v-9487530a></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><a href="https://github.com/berber1016" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://juejin.cn/user/1714893868770846" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://berber1016.github.io/typescript-eslint-chinese/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  typescript-eslint 翻译
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/rc-component/index" class="sidebar-heading clickable open"><span>rc-component</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/rc-component/rc-tree-1.html" aria-current="page" class="active sidebar-link">rc-tree</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/popper/index" class="sidebar-heading clickable"><span>popper源码</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/translation/index" class="sidebar-heading clickable"><span>一些译文</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4a1cf9c0 data-v-06036f94><h3 class="title" data-v-4a1cf9c0 data-v-4a1cf9c0></h3> <!----> <label id="box" class="inputBox" data-v-4a1cf9c0 data-v-4a1cf9c0><input type="password" value="" data-v-4a1cf9c0> <span data-v-4a1cf9c0>Konck! Knock!</span> <button data-v-4a1cf9c0>OK</button></label> <div class="footer" data-v-4a1cf9c0 data-v-4a1cf9c0><span data-v-4a1cf9c0><i class="iconfont reco-theme" data-v-4a1cf9c0></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4a1cf9c0>vuePress-theme-reco</a></span> <span data-v-4a1cf9c0><i class="iconfont reco-copyright" data-v-4a1cf9c0></i> <a data-v-4a1cf9c0><!---->
            
          <!---->
          2022
        </a></span></div></div> <div data-v-06036f94><main class="page"><section><div class="page-title"><h1 class="title">antd Design tree下层组件 rc-tree 组件源码解析</h1> <div data-v-14d37458><!----> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h1 id="antd-design-tree下层组件-rc-tree-组件源码解析"><a href="#antd-design-tree下层组件-rc-tree-组件源码解析" class="header-anchor">#</a> antd Design tree下层组件 rc-tree 组件源码解析</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>近一年看了很多 <a href="https://ant.design/index-cn" target="_blank" rel="noopener noreferrer">ant Design<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 及其下层组件的源码，学习到了一些知识，现在打算把这些知识梳理一下，所以输出了以下有关 <a href="https://github.com/react-component" target="_blank" rel="noopener noreferrer">react-component<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 组件的一些文章。本文基于 <a href="https://github.com/react-component/tree" target="_blank" rel="noopener noreferrer">rc-tree<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 组件进行分析。</p> <h2 id="源码目录结构及简析"><a href="#源码目录结构及简析" class="header-anchor">#</a> 源码目录结构及简析</h2> <p>我个人读组件源码大概分为这几个步骤。</p> <ol><li>粗览一遍大部分代码，大概知道每个文件是起什么作用的，比如说: <code>index.ts</code>文件负责导出组件及组件相关的一些东西， <code>interface.tsx</code> 负责导出一些类型定义，<code>contextType.ts</code>负责<code>context</code>类型，<code>motionTreeNode</code>、<code>TreeNode</code> 负责树节点部分，<code>Tree.tsx</code>主要是<code>Tree</code>组件的代码实现，<code>nodeList.tsx</code>负责虚拟列表及渲染列表等等，大致知道文件的目录结构及文件作用后，再开始进行下一步。</li> <li>按照文件目录，来进行进一步的查看，先去看一些辅助(指辅助函数或者类型定义)比如说：看<code>utils</code>里实现了哪些辅助函数，这些函数分别大概是做什么的，<code>interface</code>里定义了哪些类型，再从组件的主要实现开始。</li> <li>确定主要入口文件,通读整个文件，遇到不会的或者不明白的地方，先跳过，继续往下读。读完整个文件后，将文件里的内容划分模块，按照模块来进行阅读。</li> <li>按照模块阅读，逐个模块来读，争取弄明白整个模块是做什么的。</li> <li>仔细阅读完成之后，再次浏览大致浏览整个代码。</li> <li>如果还没有明白某一块内容是做什么的时候，请重复4，5 。</li></ol> <p>基本上经过以上几个步骤之后，相信你可以对源码有了一个全方位的了解，根据自己的认知，结合代码，再次体会为什么要如此设计代码。我理解这种组件级别的源码学习，主要是学习代码如何设计，如何组织自己的代码，让上下层结构更为清晰、让代码更为简洁。而不是为了读源码而读源码，本质上读源码并不会有什么收货，而是你想真的想从源码中学习什么。</p> <p>无论是上层的组件库<code>ant Design</code>还是下层的组件库 <code>react-component</code>，从文件命名上、结构目录上、代码组织上、甚至函数的命名，都有值得学习的地方，我相信大家在跟随我看完这个系列之后(不鸽的情况下)， 都可以有所收获，可以自己去尝试读一些源码，尝试提commit或者issue，甚至创造出自己设计的组件，去了解源码背后的知识。</p> <h4 id="源码目录结构"><a href="#源码目录结构" class="header-anchor">#</a> 源码目录结构</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src</span>
├── DropIndicator<span class="token punctuation">.</span>tsx
├── Indent<span class="token punctuation">.</span>tsx <span class="token comment">// 缩进组件</span>
├── MotionTreeNode<span class="token punctuation">.</span>tsx <span class="token comment">// 带动画的树节点组件</span>
├── NodeList<span class="token punctuation">.</span>tsx <span class="token comment">// 节点列表</span>
├── Tree<span class="token punctuation">.</span>tsx <span class="token comment">// index</span>
├── TreeNode<span class="token punctuation">.</span>tsx
├── contextTypes<span class="token punctuation">.</span>ts <span class="token comment">// context类型</span>
├── index<span class="token punctuation">.</span>ts <span class="token comment">// 导出</span>
├── <span class="token keyword">interface</span><span class="token punctuation">.</span>tsx <span class="token comment">// 接口</span>
├── util<span class="token punctuation">.</span>tsx
└── utils
    ├── conductUtil<span class="token punctuation">.</span>ts
    ├── diffUtil<span class="token punctuation">.</span>ts
    └── treeUtil<span class="token punctuation">.</span>ts
</code></pre></div><h4 id="rc-tree主要内容"><a href="#rc-tree主要内容" class="header-anchor">#</a> rc-tree主要内容</h4> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dd1df0136e224d13963f0339f2eae737~tplv-k3u1fbpfcp-watermark.image?" alt="rc-tree2.png"></p> <h2 id="props处理"><a href="#props处理" class="header-anchor">#</a> props处理</h2> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// src/Tree.tsx</span>
 <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>props<span class="token operator">:</span> TreeProps<span class="token punctuation">,</span> prevState<span class="token operator">:</span> TreeState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> prevProps <span class="token punctuation">}</span> <span class="token operator">=</span> prevState<span class="token punctuation">;</span>
    <span class="token keyword">const</span> newState<span class="token operator">:</span> Partial<span class="token operator">&lt;</span>TreeState<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      prevProps<span class="token operator">:</span> props<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// some code</span>
    <span class="token keyword">return</span> newState<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>props处理主要集中在 <code>getDerivedStateFromProps</code> 这个函数中，来看一下有关这个函数的介绍。</p> <blockquote><p><code>getDerivedStateFromProps</code> 会在调用 <strong>render 方法之前</strong>调用，并且在<strong>初始挂载</strong>及<strong>后续更新时</strong>都会被调用。它应<strong>返回一个对象来更新 state</strong>，如果返回 <code>null</code> 则不更新任何内容。</p></blockquote> <p>通过解读官网中的这句话可以了解到，该函数会在 render 之前、初始挂在之后、后续更新时 调用，像这样，返回一个 <code>newState</code> 来更新 <code>state</code>、</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/Tree.tsx</span>
<span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span>state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newState <span class="token operator">=</span> <span class="token function">merged</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// merged用来合并 props和state</span>
    <span class="token keyword">return</span> newState
<span class="token punctuation">}</span>
</code></pre></div><p>大致了解这个函数后，继续来看 <code>getDerivedStateFromProps</code> 中的内容，也就是我的上面伪代码中的merged 部分。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// src/Tree.tsx</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> prevProps <span class="token punctuation">}</span> <span class="token operator">=</span> prevState<span class="token punctuation">;</span>
    <span class="token keyword">const</span> newState<span class="token operator">:</span> Partial<span class="token operator">&lt;</span>TreeState<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      prevProps<span class="token operator">:</span> props<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">needSync</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevProps <span class="token operator">&amp;&amp;</span> name <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>prevProps <span class="token operator">&amp;&amp;</span> prevProps<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">!==</span> props<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>获取上一次的(也就是 props 更新前的，来自 prevState.prevProps ) <code>prevProps</code>，创建一个<code>newState</code>，设置 newState.prevProps = props(当前的props)。 这样，既拥有了当前的 props，也拥有了上一次的props。接来下有个辅助函数 <code>needSync</code> 用来判断 是否需要同步新的props中的属性到 newState中。分为两种情况</p> <ol><li><code>!prevProps &amp;&amp; name in props</code> 首次更新时，prevProps 这时候还为 <code>null</code>；</li> <li><code>prevProps &amp;&amp; prevProps[name] !== props[name]</code> 更新时，prevProps 对应的属性发生了变化时。</li></ol> <p>接下来就到了 <code>treeNode</code> 部分，也就是各式各样列表中的 data、options、dataSource、数据源，大家命名方式不一样，本质上都是一样的。用来渲染 <code>nodeList</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/Tree.ts</span>
    <span class="token keyword">let</span> <span class="token literal-property property">treeData</span><span class="token operator">:</span> DataNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> fieldNames <span class="token punctuation">}</span> <span class="token operator">=</span> prevState<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">needSync</span><span class="token punctuation">(</span><span class="token string">'fieldNames'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fieldNames <span class="token operator">=</span> <span class="token function">fillFieldNames</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>fieldNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
      newState<span class="token punctuation">.</span>fieldNames <span class="token operator">=</span> fieldNames<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>一部分一部分来看，首先创建一个新的变量 <code>treeData</code>，获取上一次的 <code>fieldNames</code>，同时判断是否需要同步 <code>fieldNames</code>， 若需要，则执行 <code>fillFieldNames(props.fieldNames)</code> 来更新 <code>fieldNames</code>。我理解该函数主要是来做，keyMapping 映射关系，来看一下这个函数。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// src/Tree.tsx</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">FieldNames</span> <span class="token punctuation">{</span>
  title<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  key<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  children<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">fillFieldNames</span><span class="token punctuation">(</span>fieldNames<span class="token operator">?</span><span class="token operator">:</span> FieldNames<span class="token punctuation">)</span><span class="token operator">:</span> Required<span class="token operator">&lt;</span>FieldNames<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> title<span class="token punctuation">,</span> key<span class="token punctuation">,</span> children <span class="token punctuation">}</span> <span class="token operator">=</span> fieldNames <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> mergedTitle <span class="token operator">=</span> title <span class="token operator">||</span> <span class="token string">'title'</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    title<span class="token operator">:</span> mergedTitle<span class="token punctuation">,</span>
    key<span class="token operator">:</span> key <span class="token operator">||</span> <span class="token string">'key'</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> children <span class="token operator">||</span> <span class="token string">'children'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>该函数可以将 <code>title</code>、<code>key</code>、<code>children</code> 映射为其他字段。比如说:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
<span class="token literal-property property">title</span><span class="token operator">:</span><span class="token string">'name'</span><span class="token punctuation">,</span>
<span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">'value'</span>
<span class="token literal-property property">children</span><span class="token operator">:</span><span class="token string">'childs'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以通过该函数，将 <code>title</code>、<code>key</code>、<code>children</code> 作为实际使用的字段在 <code>treeData</code>中。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// src/Tree.tsx</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">needSync</span><span class="token punctuation">(</span><span class="token string">'treeData'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">(</span><span class="token punctuation">{</span> treeData <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">needSync</span><span class="token punctuation">(</span><span class="token string">'children'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warning</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">'`children` of Tree is deprecated. Please use `treeData` instead.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      treeData <span class="token operator">=</span> <span class="token function">convertTreeToData</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>再往下，若 <code>treeData</code> 需要更新则更新 <code>treeData</code>，或者是否需要更新 <code>children</code>，这里需要注意一下这段代码。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">warning</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">'`children` of Tree is deprecated. Please use `treeData` instead.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里报了一个 <code>waring</code>， 提示采用 <code>JSX</code> 形式是被(deprecated)废弃的，请使用<code>treeData</code>来代替，为什么这么提示呢？先来看一下这个 <code>convertTreeToData</code> 函数，</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//src/utils/treeUtil.ts</span>
<span class="token comment">// 删掉了一些无用代码</span>
<span class="token comment">// Convert `children` of Tree into `treeData` structure.</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">convertTreeToData</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">rootNodes</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactNode</span><span class="token punctuation">)</span><span class="token operator">:</span> DataNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">dig</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactNode</span><span class="token punctuation">)</span><span class="token operator">:</span> DataNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> treeNodes <span class="token operator">=</span> <span class="token function">toArray</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// React.toArray()</span>
    <span class="token keyword">return</span> treeNodes
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">treeNode</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> key <span class="token punctuation">}</span> <span class="token operator">=</span> treeNode<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> children<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span> <span class="token operator">=</span> treeNode<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token literal-property property">dataNode</span><span class="token operator">:</span> DataNode <span class="token operator">=</span> <span class="token punctuation">{</span>
          key<span class="token punctuation">,</span>
          <span class="token operator">...</span>rest<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> parsedChildren <span class="token operator">=</span> <span class="token function">dig</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsedChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          dataNode<span class="token punctuation">.</span>children <span class="token operator">=</span> parsedChildren<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> dataNode<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">dig</span><span class="token punctuation">(</span>rootNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>该函数会将 <code>JSX</code> 转化为 <code>treeData</code>，具体转化的过程就不细看了，在这个过程中，因为是递归调用，我理解出于以下一些情况选择废弃了该场景的使用。</p> <ol><li>存在一些不必要的性能损耗，完全可以使用 <code>treeData</code> 来替代。</li> <li>边界条件判断繁琐，某个不是<code>treeNode</code>的结构也有可能被转化</li> <li>所见不是所得，比如说用<code>propover</code>或者<code>tooltip</code>组件包装了 <code>treeNode</code>，但是在转化过程中，<code>propover</code>或者<code>tooltip</code>就被丢弃掉了。</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// example</span>
<span class="token operator">&lt;</span>Tree<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>Tooltip title<span class="token operator">=</span><span class="token string">'提示'</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>TreeNode title<span class="token operator">=</span><span class="token string">'测试'</span> key<span class="token operator">=</span><span class="token string">'test'</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Tooltip<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Tree<span class="token operator">&gt;</span>
</code></pre></div><p>继续往下看</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">//src/Tree.tsx</span>
    <span class="token comment">// Save flatten nodes info and convert `treeData` into keyEntities</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>treeData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      newState<span class="token punctuation">.</span>treeData <span class="token operator">=</span> treeData<span class="token punctuation">;</span>
      <span class="token keyword">const</span> entitiesMap <span class="token operator">=</span> <span class="token function">convertDataToEntities</span><span class="token punctuation">(</span>treeData<span class="token punctuation">,</span> <span class="token punctuation">{</span> fieldNames <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      newState<span class="token punctuation">.</span>keyEntities <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token constant">MOTION_KEY</span><span class="token punctuation">]</span><span class="token operator">:</span> MotionEntity<span class="token punctuation">,</span>
        <span class="token operator">...</span>entitiesMap<span class="token punctuation">.</span>keyEntities<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token comment">// Warning if treeNode not provide key</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warningWithoutKey</span><span class="token punctuation">(</span>treeData<span class="token punctuation">,</span> fieldNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>这里有一行注释，解释了该部分的作用，将<code>treeData:DataNode[]</code>转化成为 <code>{[key]:DataNode}</code>的形式，通俗一点讲就是转为<code>Map</code>结构，不再用数组这种形式进行表达，具体有什么作用呢？可以先这里记录下来，等再次用到这个地方的时候，再来看这里。</p> <p>继续往下看</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">//src/Tree.tsx</span>
<span class="token comment">// ================ expandedKeys =================</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">needSync</span><span class="token punctuation">(</span><span class="token string">'expandedKeys'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>prevProps <span class="token operator">&amp;&amp;</span> <span class="token function">needSync</span><span class="token punctuation">(</span><span class="token string">'autoExpandParent'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      newState<span class="token punctuation">.</span>expandedKeys <span class="token operator">=</span>
        props<span class="token punctuation">.</span>autoExpandParent <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevProps <span class="token operator">&amp;&amp;</span> props<span class="token punctuation">.</span>defaultExpandParent<span class="token punctuation">)</span>
          <span class="token operator">?</span> <span class="token function">conductExpandParent</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>expandedKeys<span class="token punctuation">,</span> keyEntities<span class="token punctuation">)</span>
          <span class="token operator">:</span> props<span class="token punctuation">.</span>expandedKeys<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevProps <span class="token operator">&amp;&amp;</span> props<span class="token punctuation">.</span>defaultExpandAll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> cloneKeyEntities <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>keyEntities <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">delete</span> cloneKeyEntities<span class="token punctuation">[</span><span class="token constant">MOTION_KEY</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      newState<span class="token punctuation">.</span>expandedKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>cloneKeyEntities<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>key <span class="token operator">=&gt;</span> cloneKeyEntities<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevProps <span class="token operator">&amp;&amp;</span> props<span class="token punctuation">.</span>defaultExpandedKeys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      newState<span class="token punctuation">.</span>expandedKeys <span class="token operator">=</span>
        props<span class="token punctuation">.</span>autoExpandParent <span class="token operator">||</span> props<span class="token punctuation">.</span>defaultExpandParent
          <span class="token operator">?</span> <span class="token function">conductExpandParent</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>defaultExpandedKeys<span class="token punctuation">,</span> keyEntities<span class="token punctuation">)</span>
          <span class="token operator">:</span> props<span class="token punctuation">.</span>defaultExpandedKeys<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>这里就到了另外props处理中的其他部分 <code>expandedKeys</code>，判断如果<code>expandedKeys</code>或者<code>autoExpandParent</code> 需要更新，则执行。首先，设置新的<code>expandedKeys</code>，有<code>autoExpandParent</code>或者<code>defaultExpandParent</code>为 <code>true</code>，则执行<code>conductExpandParent(props.expandedKeys, keyEntities)</code>，否则使用传入的参数<code>expandedKeys</code>。来看一下<code>conductExpandParent</code>这个函数，该函数传入了<code>props</code>参数 <code>expandedKeys</code>和上一步得到的<code>keyEntities</code>，看一下具体函数实现</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">/**
 * If user use `autoExpandParent` we should get the list of parent node
 * @param keyList
 * @param keyEntities
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">conductExpandParent</span><span class="token punctuation">(</span>keyList<span class="token operator">:</span> Key<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keyEntities<span class="token operator">:</span> Record<span class="token operator">&lt;</span>Key<span class="token punctuation">,</span> DataEntity<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> Key<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> expandedKeys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set<span class="token operator">&lt;</span>Key<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">conductUp</span><span class="token punctuation">(</span>key<span class="token operator">:</span> Key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// some code</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">(</span>keyList <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>key <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">conductUp</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token operator">...</span>expandedKeys<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>该函数注释内容也做出了解释，如果使用<code>autoExpandParent</code>参数的话，获取list的父节点，<code>keyList</code> 参数是需要展开的节点，<code>keyEntities</code> 参数是上一部分生成的<code>{[key]:DataNode}</code>结构的对象。遍历<code>KeyList</code> 执行 <code>conductUp</code> 函数，</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">//src/Tree.tsx</span>
  <span class="token keyword">function</span> <span class="token function">conductUp</span><span class="token punctuation">(</span>key<span class="token operator">:</span> Key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>expandedKeys<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> entity <span class="token operator">=</span> keyEntities<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entity<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    expandedKeys<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span> parent<span class="token punctuation">,</span> node <span class="token punctuation">}</span> <span class="token operator">=</span> entity<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>disabled<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">conductUp</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>conductUp</code> 这个函数也比较简单，在 <code>keyEntities</code> 中获取 <code>entity</code>。 首先：如果有 <code>entity</code>，直接返回，表示了该Key就是父节点，不需要展开。如果没有则在 <code>expandedKeys</code> (Set结构)增加该Key，若当前Key对应的节点是 <code>disabled</code> 状态，则返回，若有 <code>parent</code>节点，递归执行 <code>conductUp</code>。相信大家都知道为什么要递归执行吧，假设当前Key为第三级，这时取到的 <code>parent</code> 为第二级，还要打开第二级，所以递归执行该函数。</p> <p>到这里也明白了在上一步生成的 <code>keyEntities</code> 对象在这里起到的作用，利用空间换时间的方式，可以在O(1)的时间内取到对应的Key。</p> <p>继续往下看</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//src/Tree.tsx</span>
<span class="token comment">// ================ flattenNodes =================</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>treeData <span class="token operator">||</span> newState<span class="token punctuation">.</span>expandedKeys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token literal-property property">flattenNodes</span><span class="token operator">:</span> FlattenNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">flattenTreeData</span><span class="token punctuation">(</span>
        treeData <span class="token operator">||</span> prevState<span class="token punctuation">.</span>treeData<span class="token punctuation">,</span>
        newState<span class="token punctuation">.</span>expandedKeys <span class="token operator">||</span> prevState<span class="token punctuation">.</span>expandedKeys<span class="token punctuation">,</span>
        fieldNames<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      newState<span class="token punctuation">.</span>flattenNodes <span class="token operator">=</span> flattenNodes<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><code>flattenNodes</code>模块，若有 <code>treeData</code> 或有新的需要展开的Key，则利用 <code>flattenTreeData</code> 重新生成 <code>flattenNodes</code> 该方法会将数组扁平化处理，<code>flattenTreeData</code> 这个方法留到 <code>nodeList</code> 部分再细说，在这里先放一放。</p> <p>继续往下看</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">//src/Tree.tsx</span>
<span class="token comment">// ================ selectedKeys =================</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>selectable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">needSync</span><span class="token punctuation">(</span><span class="token string">'selectedKeys'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newState<span class="token punctuation">.</span>selectedKeys <span class="token operator">=</span> <span class="token function">calcSelectedKeys</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>selectedKeys<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevProps <span class="token operator">&amp;&amp;</span> props<span class="token punctuation">.</span>defaultSelectedKeys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newState<span class="token punctuation">.</span>selectedKeys <span class="token operator">=</span> <span class="token function">calcSelectedKeys</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>defaultSelectedKeys<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>该模块是用来计算选中的Keys，若<code>selectable</code>且<code>selectedKeys</code>有变化时，计算<code>selectedKeys</code>。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">//src/util.tsx</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">calcSelectedKeys</span><span class="token punctuation">(</span>selectedKeys<span class="token operator">:</span> Key<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> props<span class="token operator">:</span> TreeProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>selectedKeys<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> multiple <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>multiple<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> selectedKeys<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedKeys<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>selectedKeys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> selectedKeys<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>calcSelectedKeys</code>这个函数也比较简单，不过需要注意的是，如果是(multiple)多选状态，则返回一个新的引用(浅拷贝)，如果不是(multiple)多选状态，且 <code>selectedKeys</code> 是个数组，则会取数组中的第一位(也是一个新的引用)。否则直接返回 <code>selectedKeys</code>。多说一点有过<code>slice()</code>的执行方式，来看一下<a href="https://tc39.es/ecma262" target="_blank" rel="noopener noreferrer">ECMAScript<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的文档</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a6a945b22b964420ab7ae44124f8bb66~tplv-k3u1fbpfcp-watermark.image?" alt="image.png">
解释一下1、2、3....就是官方文档定义了<code>slice</code>函数执行的步骤，可以根据该步骤来实现<code>slice</code>函数,
核心关注这几步:</p> <ol start="3"><li>Let <code>relativeStart</code> be ? <a href="https://tc39.es/ecma262/#sec-tointegerorinfinity" target="_blank" rel="noopener noreferrer">ToIntegerOrInfinity<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>(<code>start</code>). 这段话大约等于下面代码(下面同理)</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">ToNumber</span><span class="token punctuation">(</span><span class="token parameter">argument</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> argument <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">NaN</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//some code </span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">ToInterOrInfinity</span><span class="token punctuation">(</span><span class="token parameter">argument</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">ToNumber</span><span class="token punctuation">(</span>argument<span class="token punctuation">)</span>
    <span class="token comment">//some code </span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> relativeStart <span class="token operator">=</span> <span class="token function">ToIntegerOrInfinity</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span> <span class="token comment">// 0</span>
</code></pre></div><p>6. Else, let <code>k</code> be <a href="https://tc39.es/ecma262/#eqn-min" target="_blank" rel="noopener noreferrer">min<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>(<code>relativeStart</code>, <code>len</code>).</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> k <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>relativeStart<span class="token punctuation">,</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// relativeStart;</span>
</code></pre></div><p>7. If <code>end</code> is undefined, let <code>relativeEnd</code> be <code>len</code>; else let <code>relativeEnd</code> be? <a href="https://tc39.es/ecma262/#sec-tointegerorinfinity" target="_blank" rel="noopener noreferrer">ToIntegerOrInfinity<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>(<code>end</code>).</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> relativeEnd
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> end <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    relativeEnd <span class="token operator">=</span> length
<span class="token punctuation">}</span> 
relativeEnd <span class="token operator">=</span> <span class="token function">ToIntegerOrInfinity</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>10. Else, let <code>final</code> be <a href="https://tc39.es/ecma262/#eqn-min" target="_blank" rel="noopener noreferrer">min<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>(<code>relativeEnd</code>, <code>len</code>).
11. Let <code>count</code> be <a href="https://tc39.es/ecma262/#eqn-max" target="_blank" rel="noopener noreferrer">max<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>(<code>final</code> - <code>k</code>, 0).
12. Let <code>A</code> be ? <a href="https://tc39.es/ecma262/#sec-arrayspeciescreate" target="_blank" rel="noopener noreferrer">ArraySpeciesCreate<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>(<code>O</code>, <code>count</code>).
13. Let <code>n</code> be 0.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> final <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>relativeEnd<span class="token punctuation">,</span>len<span class="token punctuation">)</span> <span class="token comment">// relativeEnd;</span>
<span class="token keyword">let</span> count <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>final <span class="token operator">-</span> k<span class="token punctuation">,</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// final - k === final</span>
<span class="token keyword">let</span> <span class="token constant">A</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>final<span class="token punctuation">)</span> <span class="token comment">// new Array(length)</span>
</code></pre></div><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a68f84c2a275433c9e04649fd5e2c3b0~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// k = 0;</span>
<span class="token comment">// final = length;</span>
<span class="token keyword">while</span><span class="token punctuation">(</span>k <span class="token operator">&lt;</span> final<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> Pk <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> kPresent <span class="token operator">=</span> <span class="token constant">O</span><span class="token punctuation">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span>Pk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>kPresent<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> kValue <span class="token operator">=</span> <span class="token constant">O</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Pk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果该步骤失败，则 throw a TypeError exception</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
    <span class="token constant">A</span><span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> kValue<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">TypeError </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    k<span class="token operator">++</span><span class="token punctuation">;</span>
    n<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>15. Perform ? <a href="https://tc39.es/ecma262/#sec-set-o-p-v-throw" target="_blank" rel="noopener noreferrer">Set<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>(<code>A</code>, &quot;length&quot;, <a href="https://tc39.es/ecma262/#%F0%9D%94%BD" target="_blank" rel="noopener noreferrer">𝔽<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>(<code>n</code>), true).
16. Return <code>A</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">A</span><span class="token punctuation">.</span>length <span class="token operator">=</span> n<span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token constant">A</span><span class="token punctuation">;</span>
</code></pre></div><p>一些其他跟 <code>slice()</code> 不太相关的我就不贴了，可以看出来当 <code>slice</code> 函数不传参数时，会默认设置start和end，然后创建一个<code>Array(length)</code>,循环赋值，最后返回这个<code>Array</code>。 相信经过这样分析后，对于 <code>Array.prototype.slice</code> 函数都有了新的认知~。</p> <p>到这里，关于 props的处理就已经完成了。总的来看的话，分析了<code>getDerivedStateFromProps</code>函数的作用，将<code>getDerivedStateFromProps</code>中的代码拆分成对应的小的模块来进行梳理。</p> <h2 id="event事件"><a href="#event事件" class="header-anchor">#</a> event事件</h2> <p>在 <code>rc-tree</code> 组件中，event事件大致分为以下几种类型</p> <ol><li><p>Drag</p></li> <li><p>Check
<code>drag</code>和 <code>check</code> 操作都比较复杂，计划系统的说明一下，应该会在下一篇中进行说明。</p></li> <li><p>select</p></li></ol> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function-variable function">onNodeSelect</span> <span class="token operator">=</span> <span class="token punctuation">(</span>e<span class="token punctuation">,</span> treeNode<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> selectedKeys <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> keyEntities<span class="token punctuation">,</span> fieldNames <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> onSelect<span class="token punctuation">,</span> multiple <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> selected <span class="token punctuation">}</span> <span class="token operator">=</span> treeNode<span class="token punctuation">;</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> treeNode<span class="token punctuation">[</span>fieldNames<span class="token punctuation">.</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> targetSelected <span class="token operator">=</span> <span class="token operator">!</span>selected<span class="token punctuation">;</span>

    <span class="token comment">// Update selected keys</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>targetSelected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      selectedKeys <span class="token operator">=</span> <span class="token function">arrDel</span><span class="token punctuation">(</span>selectedKeys<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>multiple<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      selectedKeys <span class="token operator">=</span> <span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      selectedKeys <span class="token operator">=</span> <span class="token function">arrAdd</span><span class="token punctuation">(</span>selectedKeys<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token punctuation">{</span>
        event<span class="token operator">:</span> <span class="token string">'select'</span><span class="token punctuation">,</span>
        selected<span class="token operator">:</span> targetSelected<span class="token punctuation">,</span>
        node<span class="token operator">:</span> treeNode<span class="token punctuation">,</span>
        selectedNodes<span class="token operator">:</span>selectedKeys<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>selectedKey <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keyEntities<span class="token punctuation">[</span>selectedKey<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> keyEntities<span class="token punctuation">[</span>selectedKey<span class="token punctuation">]</span><span class="token punctuation">.</span>node<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>node <span class="token operator">=&gt;</span> node<span class="token punctuation">)</span><span class="token punctuation">,</span>
        nativeEvent<span class="token operator">:</span> e<span class="token punctuation">.</span>nativeEvent<span class="token punctuation">,</span>
      <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setUncontrolledState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> selectedKeys <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>onSelect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">onSelect</span><span class="token punctuation">(</span>selectedKeys<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>来看一下跟<code>onSelect</code> 相关的代码。先获取了一些必要的参数，判断当前执行<code>onSelect</code>的 <code>Node</code>，根据是否被选中来更新 <code>selectedKeys</code>,然后构建一个 <code>selectedNodes</code>，执行传入的 <code>props.onSelect</code> 方法。
4. ### click、doubleclick、mouseLeave、focus、blur等</p> <p>这些原生的事件没什么好说的，都十分简单，自己看相应的源码即可。</p> <h2 id="context和render"><a href="#context和render" class="header-anchor">#</a> context和render</h2> <p>熟悉 <code>React</code> 的同学大概都知道 <code>Context</code> 怎么使用吧，<code>Context</code> 提供了一种在组件之间共享此类值的方式，而不必显式地通过组件树的逐层传递 <code>props</code>。当有大量参数需要隔组件传递时，可以使用 <code>Context</code>来进行参数的共享。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">TreeContext.Provider</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">NodeList</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
 </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">TreeContext.Provider</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>参考资料</p> <p><a href="https://tc39.es/ecma262" target="_blank" rel="noopener noreferrer">ECMAScript文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://github.com/react-component" target="_blank" rel="noopener noreferrer">react-component<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://github.com/react-component/tree" target="_blank" rel="noopener noreferrer">rc-tree<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2022/5/26 21:52:47</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/popper/2x.html">
            2.x
          </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-6c8a9a73><li class="level-2" data-v-6c8a9a73><a href="/rc-component/rc-tree-1.html#前言" class="sidebar-link reco-side-前言" data-v-6c8a9a73>前言</a></li><li class="level-2" data-v-6c8a9a73><a href="/rc-component/rc-tree-1.html#源码目录结构及简析" class="sidebar-link reco-side-源码目录结构及简析" data-v-6c8a9a73>源码目录结构及简析</a></li><li class="level-2" data-v-6c8a9a73><a href="/rc-component/rc-tree-1.html#props处理" class="sidebar-link reco-side-props处理" data-v-6c8a9a73>props处理</a></li><li class="level-2" data-v-6c8a9a73><a href="/rc-component/rc-tree-1.html#event事件" class="sidebar-link reco-side-event事件" data-v-6c8a9a73>event事件</a></li><li class="level-2" data-v-6c8a9a73><a href="/rc-component/rc-tree-1.html#context和render" class="sidebar-link reco-side-context和render" data-v-6c8a9a73>context和render</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.bd205e11.js" defer></script><script src="/assets/js/3.eb454419.js" defer></script><script src="/assets/js/1.88cb3713.js" defer></script><script src="/assets/js/16.2d1bbd9a.js" defer></script>
  </body>
</html>
